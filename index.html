<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Calendario de Turnos Chile</title>
    
    <!-- Reemplazar CDN de Tailwind con versión de producción -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Paleta de colores mejorada - Modo claro */
            --primary: #1976d2;         /* Azul más vibrante */
            --primary-light: #42a5f5;   /* Azul claro */
            --primary-dark: #0d47a1;    /* Azul oscuro */
            --secondary: #ff6d00;       /* Naranja más vibrante */
            --secondary-light: #ff9e40; /* Naranja claro */
            --background: #f0f2f5;      /* Fondo más contrastado */
            --background-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231976d2' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            --card: #ffffff;            /* Tarjetas blancas */
            --text: #212121;            /* Texto más oscuro para mejor contraste */
            --text-light: #757575;      /* Texto secundario */
            --border: rgba(0, 0, 0, 0.1); /* Color de bordes */
            --border-radius: 12px;      /* Bordes más redondeados */
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            
            /* Colores para los turnos */
            --turno-dia: #ffd600;       /* Amarillo más vibrante para día */
            --turno-noche: #3949ab;     /* Azul índigo para noche */
            --turno-extra-dia: #ff9100; /* Naranja ámbar para extra día */
            --turno-extra-noche: #7b1fa2; /* Púrpura para extra noche */
            --holiday-cell: #ffe5e5;
            --saturday-cell: #e7f2ff;
            --sunday-cell: #ffecec;
            --today-ring: #42a5f5;
        }

        .dark-mode {
            --background: #000000;
            --background-pattern: none;
            --card: #0a0a0a;
            --text: #e0e0e0;
            --text-light: #b0b0b0;
            --border: #3a3a3a;
            --shadow: 0 4px 10px rgba(0,0,0,0.65);
            --primary: #FFB74D;
            --primary-light: #FFD180;
            --primary-dark: #F57C00;
            --secondary: #D16F40;
            --secondary-light: #E4956C;
            --secondary-dark: #A6542E;
            --turno-dia: #FFB74D;
            --turno-noche: #B85C38;
            --turno-extra-dia: #FFCC80;
            --turno-extra-noche: #8D4A29;
            --holiday-cell: #3a0000;
            --saturday-cell: #001b33;
            --sunday-cell: #2b0000;
            --today-ring: #FFD180;
        }

        /* Paleta suave propuesta: tonos desaturados y profesionales */
        .dark-mode.soft-palette {
            --background: #000000;
            --card: #0a0a0a;
            --text: #e6e6e6;
            --text-light: #b8b8b8;
            --border: #3a3a3a;
            --shadow: 0 4px 10px rgba(0,0,0,0.65);
            --primary: #FFB74D;
            --primary-light: #FFD180;
            --primary-dark: #F57C00;
            --secondary: #D16F40;
            --secondary-light: #E4956C;
            --secondary-dark: #A6542E;
            --turno-dia: #FFB74D;
            --turno-noche: #B85C38;
            --turno-extra-dia: #FFCC80;
            --turno-extra-noche: #8D4A29;
        }
        

        body {
            background-color: var(--background);
            background-image: var(--background-pattern);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            transition: all 0.3s ease;
            padding-bottom: 60px; /* Espacio para el menú inferior en móviles */
        }

        .day {
            position: relative;
        }
        .day.holiday { background-color: var(--holiday-cell); }
        .day.saturday { background-color: var(--saturday-cell); }
        .day.sunday { background-color: var(--sunday-cell); }
        .day.today { outline: 2px solid var(--today-ring); outline-offset: -2px; }
        .day-badge { position: absolute; top: 4px; right: 4px; font-size: 0.65rem; opacity: 0.9; }

        .card {
            background-color: var(--card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            backdrop-filter: blur(5px);
        }

        .btn-primary {
            background-color: var(--primary);
            color: #000000;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .brand-gradient {
            background-image: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Estilos para pestañas mejorados para móviles */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
        }

        .tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }

        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            color: var(--text-light);
            transition: all 0.2s ease;
        }

        .tab i {
            margin-right: 0.5rem;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Estilos específicos para móviles */
        @media (max-width: 640px) {
            .tabs {
                display: none; /* Ocultar pestañas en móviles */
            }
            
            /* Estilos para el menú de navegación inferior en móviles */
            .mobile-nav {
                display: block;
                border-top: 1px solid var(--border);
            }
            
            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 8px 4px;
                border-radius: 8px;
                color: var(--text);
                transition: all 0.2s ease;
            }
            
            .mobile-nav-item.active {
                color: var(--primary);
                background-color: rgba(25, 118, 210, 0.15);
            }
            
            .mobile-nav-item:active {
                transform: scale(0.9);
            }
            
            .mobile-nav-item i {
                font-size: 1.25rem;
                margin-bottom: 4px;
            }
            
            .mobile-nav-item span {
                font-size: 0.7rem;
            }
            
            /* Ajustar espacio para el menú inferior */
            body {
                padding-bottom: 60px;
            }
        }

        /* Para pantallas muy pequeñas */
        @media (max-width: 360px) {
            .mobile-nav-item i {
                font-size: 1.1rem;
            }
            
            .mobile-nav-item span {
                font-size: 0.65rem;
            }
        }

        /* Estilos para el menú de navegación inferior en móviles */
        .mobile-nav {
            display: none;
        }
        
        @media (max-width: 640px) {
            .mobile-nav {
                display: block;
            }
            
            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 8px;
                border-radius: 8px;
                color: var(--text);
                transition: all 0.2s ease;
            }
            
            .mobile-nav-item.active {
                color: var(--primary);
                background-color: rgba(25, 118, 210, 0.15);
            }
            
            .mobile-nav-item:active {
                transform: scale(0.9);
            }
        }

        /* Mejoras para dispositivos móviles */
        @media (max-width: 640px) {
            .day {
                min-height: 40px;
                padding: 2px;
            }
            
            .turno {
                display: none;
            }
            
            .day-header {
                font-size: 0.7rem;
                padding: 2px;
            }
            
            .mobile-day-number {
                font-size: 0.7rem;
            }
            
            .mobile-turno-indicator {
                width: 8px;
                height: 8px;
                bottom: 1px;
            }
            
            .container {
                padding: 0.5rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .card {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .tabs {
                gap: 0;
            }
            
            .tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .tab i {
                margin-right: 0.25rem;
            }
            
            .btn-primary, .btn-secondary {
                padding: 0.4rem 0.75rem !important;
                font-size: 0.8rem;
            }
            
            .modal-content {
                width: 95%;
                padding: 1rem;
            }
            
            select, input[type="date"], textarea {
                font-size: 0.9rem;
            }
            
            .grid-cols-2, .grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .day {
                min-height: 35px;
            }
            
            .mobile-day-number {
                font-size: 0.6rem;
            }
            
            .calendar {
                gap: 0.5px;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
                white-space: nowrap;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .flex-wrap {
                justify-content: center;
            }
        }

        /* Mejoras para la visualización de turnos en móviles */
        @media (max-width: 640px) {
            .mobile-turno-indicator {
                position: absolute;
                bottom: 2px;
                left: 50%;
                transform: translateX(-50%);
            }
            
            /* Mostrar múltiples indicadores en una fila */
            .day:has(.mobile-turno-indicator:nth-child(n+3)) .mobile-turno-indicator:nth-child(3) {
                left: calc(50% - 10px);
            }
            
            .day:has(.mobile-turno-indicator:nth-child(n+3)) .mobile-turno-indicator:nth-child(4) {
                left: calc(50% + 10px);
            }
            
            /* Ajustar el modal para móviles */
            .modal-content {
                max-width: 300px;
            }
        }

        /* Mejoras para la interacción táctil */
        @media (hover: none) {
            .btn-primary:active, .btn-secondary:active {
                transform: scale(0.95);
            }
            
            .day:active {
                transform: scale(0.98);
            }
        }

        

        /* Estilos para el calendario */
        .day {
            min-height: 80px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 5px;
            position: relative;
            transition: all 0.2s ease;
            background-color: var(--card);
        }

        .weekend {
            background-color: rgba(25, 118, 210, 0.05);
        }

        .dark-mode .weekend {
            background-color: rgba(255, 183, 77, 0.08);
        }

        .day:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            min-height: auto;
            padding: 10px 5px;
            background-color: var(--primary);
            color: white;
            border-radius: var(--border-radius);
        }

        .day-header.weekend {
            background-color: var(--secondary);
        }

        .empty-day {
            background-color: transparent;
            border: none;
            box-shadow: none;
        }

        .empty-day:hover {
            transform: none;
            box-shadow: none;
        }

        /* Indicador de bloqueo */
        .lock-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            color: var(--secondary);
            font-size: 0.85rem;
        }

        .day.locked {
            outline: 2px dashed var(--secondary);
            outline-offset: -2px;
        }

        .today {
            border: 2px solid var(--primary);
            background-color: rgba(33, 150, 243, 0.05);
        }

        .turno {
            margin-top: 6px;
            padding: 6px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            text-align: center;
            box-shadow: var(--shadow);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            animation: badgeIn 0.2s ease;
        }

        @keyframes badgeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .legend {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .legend-dia { background-color: var(--turno-dia); color: #333; }
        .legend-noche { background-color: var(--turno-noche); color: #fff; }
        .legend-extra-dia { background-color: var(--turno-extra-dia); color: #fff; }
        .legend-extra-noche { background-color: var(--turno-extra-noche); color: #fff; }

        .mini-calendar { display: grid; grid-template-columns: repeat(7, 10px); gap: 2px; }
        .mini-day { width: 10px; height: 10px; border-radius: 2px; background-color: var(--card); border: 1px solid var(--border); }
        .mini-day.has { background-color: var(--primary); border-color: var(--primary-dark); }
        .mini-day.extra { outline: 1px solid var(--secondary); }

        #monthlyContainer.monthly-anim { transition: transform 300ms ease; }
        #monthlyContainer.expanded { transform: scale(1.01); }

        /* Animación de colapso para vista anual */
        #annualView.annual-anim { transition: max-height 300ms ease, opacity 300ms ease; overflow: hidden; }
        #annualView { max-height: 2000px; }
        #annualView.annual-collapsed { max-height: 0; opacity: 0; }

        .dia {
            background-color: var(--turno-dia);
            color: #333 !important; /* Forzar color oscuro para mejor contraste */
            font-weight: 600;
        }

        .noche {
            background-color: var(--turno-noche);
            color: white !important; /* Forzar color claro para mejor contraste */
            font-weight: 600;
        }

        .extra-dia {
            background-color: var(--turno-extra-dia);
            color: white !important; /* Forzar color claro para mejor contraste */
            font-weight: 600;
        }

        .extra-noche {
            background-color: var(--turno-extra-noche);
            color: white !important; /* Forzar color claro para mejor contraste */
            font-weight: 600;
        }

        .feriado {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: red;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: auto;
            max-width: 180px;
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            text-align: center;
            border-radius: var(--border-radius);
            padding: 6px 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .mobile-day-number {
            font-size: 0.95rem;
            font-weight: 700;
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos para botones secundarios */
        .btn-secondary {
            background-color: var(--secondary);
            color: #000000;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Estilos para indicadores de turno en móviles */
        .mobile-turno-indicator {
            display: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Modo compacto */
        .compact-mode .turno { display: none; }
        .compact-mode .mobile-turno-indicator { display: block; }
        .compact-mode .day { min-height: 35px; }

        .mobile-dia {
            background-color: var(--turno-dia);
        }

        .mobile-noche {
            background-color: var(--turno-noche);
        }

        .mobile-extra-dia {
            background-color: var(--turno-extra-dia);
        }

        .mobile-extra-noche {
            background-color: var(--turno-extra-noche);
        }

        /* Estilos para móviles */
        @media (max-width: 640px) {
            .mobile-day-number {
                font-size: 0.8rem;
                font-weight: bold;
                text-align: center;
            }
            
            .turno {
                display: none;
            }
            
            .mobile-turno-indicator {
                display: block;
            }
        }

        /* Corregir el color de texto en los textareas para modo oscuro */
        textarea {
            color: var(--text);
            background-color: var(--card);
            border: 1px solid var(--border);
        }

        .dark-mode textarea {
            color: var(--text);
            background-color: var(--card);
            border-color: var(--border);
        }

        /* Asegurar que los textareas de estadísticas sean legibles */
        #diasNormales, #diasExtras {
            color: var(--text);
            background-color: var(--card);
            border: 1px solid var(--border);
        }

        .dark-mode #diasNormales, .dark-mode #diasExtras {
            color: var(--text);
            background-color: rgba(30, 30, 30, 0.8);
            border-color: var(--border);
        }

        .dark-mode {
            --background: #000000;
            --background-pattern: none;
            --card: #0a0a0a;
            --text: #e0e0e0;
            --text-light: #b0b0b0;
            --border: #3a3a3a;
            --shadow: 0 4px 10px rgba(0,0,0,0.65);
            --primary: #FFB74D;
            --primary-light: #FFD180;
            --primary-dark: #F57C00;
            --secondary: #D16F40;
            --secondary-light: #E4956C;
            --secondary-dark: #A6542E;
            --turno-dia: #FFB74D;
            --turno-noche: #B85C38;
            --turno-extra-dia: #FFCC80;
            --turno-extra-noche: #8D4A29;
        }

        /* Asegurar que los selectores y inputs tengan colores correctos en modo oscuro */
        .dark-mode select,
        .dark-mode input[type="date"],
        .dark-mode input[type="number"],
        .dark-mode textarea {
            color: var(--text);
            background-color: var(--card);
            border-color: var(--border);
        }

        /* Asegurar que los textos en las tarjetas sean visibles */
        .dark-mode .card {
            color: var(--text);
        }

        /* Asegurar que los textos en los días del calendario sean visibles */
        .dark-mode .day {
            color: var(--text);
        }

        /* Asegurar que los textos en los botones sean visibles */
        .dark-mode .btn-primary { color: #000000; }
        .dark-mode .btn-secondary { color: #000000; }

        /* Asegurar que los textos en las estadísticas sean visibles */
        .dark-mode .text-gray-600,
        .dark-mode .text-gray-500,
        .dark-mode .text-gray-700 {
            color: var(--text-light);
        }

        .dark-mode .text-blue-600,
        .dark-mode .text-green-600,
        .dark-mode .text-yellow-600,
        .dark-mode .text-purple-600 {
            color: white;
        }

        /* Asegurar que los fondos de las estadísticas tengan buen contraste */
        .dark-mode .bg-blue-100 {
            background-color: rgba(33, 150, 243, 0.2);
        }

        .dark-mode .bg-green-100 {
            background-color: rgba(76, 175, 80, 0.2);
        }

        .dark-mode .bg-yellow-100 {
            background-color: rgba(255, 235, 59, 0.2);
        }

        .dark-mode .bg-purple-100 {
            background-color: rgba(156, 39, 176, 0.2);
        }

        .dark-mode .bg-gray-100 {
            background-color: rgba(66, 66, 66, 0.2);
        }

        /* Menú superior responsivo */
        #controlsBar { max-width: 100%; box-sizing: border-box; }
        .controls-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .controls-selects { display: flex; gap: 8px; justify-content: center; }
        @media (max-width: 640px) {
            #controlsBar { display: flex; flex-direction: column; gap: 10px; }
            .controls-group { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
            .controls-group .btn-secondary { width: 100%; min-height: 36px; }
            .controls-selects { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
            #monthSelect, #yearSelect { width: 100%; min-height: 36px; }
        }
    </style>
</head>
<body class="dark-mode transition-colors duration-300" id="body">
    <!-- Estructura principal con pestañas -->
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 md:mb-6">
            <h1 class="text-2xl md:text-3xl font-bold mb-3 md:mb-0 text-center md:text-left brand-gradient">
                <i class="fas fa-calendar-alt mr-2"></i>Calendario de Turnos
            </h1>
            <div class="flex items-center space-x-2 md:space-x-4">
                <button onclick="cambiarTema()" class="btn-primary px-3 py-1 md:px-4 md:py-2 rounded-lg flex items-center text-sm md:text-base">
                    <i class="fas fa-moon mr-1 md:mr-2"></i><span class="hidden sm:inline">Cambiar Tema</span>
                </button>
                <select id="userSwitcher" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm md:text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></select>
                <span id="userSwitcherColor" class="inline-block w-4 h-4 rounded-full border border-gray-500"></span>
            </div>
        </div>

        <!-- Selector de mes/año -->
        <div class="card p-3 md:p-4 mb-4 md:mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                <div class="text-lg md:text-xl font-bold text-primary dark:text-primary-light text-center sm:text-left" id="monthYear"></div>
                <div id="controlsBar" class="w-full sm:w-auto">
                    <div id="controlsGroup" class="controls-group">
                        <button aria-label="Año anterior" onclick="cambiarAño(-1)" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-angle-double-left"></i></button>
                        <button aria-label="Mes anterior" onclick="cambiarMes(-1)" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-chevron-left"></i></button>
                        <button aria-label="Mes siguiente" onclick="cambiarMes(1)" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-chevron-right"></i></button>
                        <button aria-label="Año siguiente" onclick="cambiarAño(1)" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-angle-double-right"></i></button>
                        <button aria-label="Ir a hoy" onclick="goToToday()" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-dot-circle"></i></button>
                        <button aria-label="Ir al próximo turno" onclick="irAlProximoTurno()" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-location-arrow"></i></button>
                        <button aria-label="Ir al próximo libre" onclick="irAlProximoLibre()" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-walking"></i></button>
                        <button aria-label="Modo compacto" onclick="toggleCompacto()" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-compress"></i></button>
                        <button aria-label="Selector de mes" onclick="toggleMonthGrid()" class="btn-secondary px-2 py-2 rounded"><i class="fas fa-th"></i></button>
                        <button aria-label="Mostrar u ocultar vista anual" onclick="toggleAnnualView()" class="btn-secondary px-2 py-2 rounded"><i id="annualToggleIcon" class="fas fa-eye"></i></button>
                    </div>
                    <div id="controlsSelects" class="controls-selects">
                        <select id="monthSelect" onchange="actualizarCalendario()" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm md:text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                        <select id="yearSelect" onchange="actualizarCalendario()" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm md:text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="monthGrid" class="mt-2 hidden">
                <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(0)">Ene</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(1)">Feb</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(2)">Mar</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(3)">Abr</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(4)">May</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(5)">Jun</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(6)">Jul</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(7)">Ago</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(8)">Sep</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(9)">Oct</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(10)">Nov</button>
                    <button class="btn-secondary py-1 rounded" onclick="seleccionarMes(11)">Dic</button>
                </div>
            </div>
        </div>

        <!-- Sistema de pestañas mejorado para móviles -->
        <div class="card p-4 mb-6">
            <div class="tabs">
                <div class="tab active" onclick="cambiarPestaña('calendario')">
                    <i class="fas fa-calendar"></i> 
                    <span>Calendario</span>
                </div>
                <div class="tab" onclick="cambiarPestaña('estadisticas')">
                    <i class="fas fa-chart-bar"></i> 
                    <span>Estadísticas</span>
                </div>
                <div class="tab" onclick="cambiarPestaña('herramientas')">
                    <i class="fas fa-tools"></i> 
                    <span>Herramientas</span>
                </div>
                <div class="tab" onclick="cambiarPestaña('configuracion')">
                    <i class="fas fa-cog"></i> 
                    <span>Config</span>
                </div>
            </div>
            
            <!-- Contenido de las pestañas -->
            <div id="tab-calendario" class="tab-content active">
                <div class="md:grid md:grid-cols-3 gap-3">
                    <div id="monthlyContainer" class="md:col-span-2 monthly-anim">
                        <div class="card p-3 mb-3">
                            <div class="legend">
                                <div class="legend-item legend-dia"><i class="fas fa-sun"></i><span>Día</span></div>
                                <div class="legend-item legend-noche"><i class="fas fa-moon"></i><span>Noche</span></div>
                                <div class="legend-item legend-extra-dia"><i class="fas fa-plus"></i><span>Extra Día</span></div>
                                <div class="legend-item legend-extra-noche"><i class="fas fa-plus"></i><span>Extra Noche</span></div>
                            </div>
                        </div>
                        <div class="card p-3 mb-3" id="progressBlock"></div>
                        <div id="calendar" class="grid grid-cols-7 gap-2 md:gap-3"></div>
                    </div>
                    <div id="annualView" class="card p-3 annual-anim"></div>
                </div>
            </div>

            <div id="tab-estadisticas" class="tab-content">
                <!-- Contenido de estadísticas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <h3 class="font-semibold text-lg mb-3">
                            <i class="fas fa-chart-pie mr-2"></i>Resumen del Mes
                        </h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg">
                                <div class="text-sm text-gray-600 dark:text-gray-300">Días Trabajados</div>
                                <div class="text-2xl font-bold text-blue-600 dark:text-blue-300" id="diasTrabajados">0</div>
                            </div>
                            <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg">
                                <div class="text-sm text-gray-600 dark:text-gray-300">Días Libres</div>
                                <div class="text-2xl font-bold text-green-600 dark:text-green-300" id="diasLibres">0</div>
                            </div>
                            <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-lg">
                                <div class="text-sm text-gray-600 dark:text-gray-300">Horas Normales</div>
                                <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-300" id="horasNormales">0</div>
                            </div>
                            <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-lg">
                                <div class="text-sm text-gray-600 dark:text-gray-300">Horas Extras</div>
                                <div class="text-2xl font-bold text-purple-600 dark:text-purple-300" id="horasExtras">0</div>
                            </div>
                        </div>
                        <div class="mt-3 bg-gray-100 dark:bg-gray-800 p-3 rounded-lg">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Total Horas</div>
                            <div class="text-2xl font-bold text-gray-700 dark:text-gray-200" id="totalHoras">0</div>
                        </div>
                    </div>
                    
                    <div class="card p-4">
                        <h3 class="font-semibold text-lg mb-3">
                            <i class="fas fa-list-ul mr-2"></i>Detalle de Turnos
                        </h3>
                        <div class="mb-3">
                            <label class="block text-sm font-medium mb-1">Turnos Normales</label>
                            <div class="relative">
                                <textarea id="diasNormales" rows="5" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700" readonly></textarea>
                                <button onclick="copiarNormales()" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Turnos Extras</label>
                            <div class="relative">
                                <textarea id="diasExtras" rows="5" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700" readonly></textarea>
                                <button onclick="copiarExtras()" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-herramientas" class="tab-content">
                <!-- Contenido de herramientas -->
                <div class="card p-4 mb-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-file-export mr-2"></i>Exportar/Importar
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="exportarAPDF()" class="btn-secondary py-2 rounded">
                            <i class="fas fa-file-pdf mr-2"></i>Exportar a PDF
                        </button>
                        <label class="btn-secondary py-2 rounded text-center cursor-pointer">
                            <i class="fas fa-database mr-2"></i>Importar JSON
                            <input type="file" id="importarJSONArchivo" accept="application/json,.json" class="hidden" onchange="importarDesdeJSON(event)">
                        </label>
                        <label class="btn-primary py-2 rounded text-center cursor-pointer">
                            <i class="fas fa-file-upload mr-2"></i>Importar desde TXT
                            <input type="file" id="importarArchivo" accept=".txt" class="hidden" onchange="importarDesdeTXT(event)">
                        </label>
                        <button onclick="limpiarMes()" class="bg-red-500 hover:bg-red-600 text-white py-2 rounded">
                            <i class="fas fa-trash-alt mr-2"></i>Limpiar Mes Actual
                        </button>
                    </div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-2 items-end">
                        <div>
                            <label class="block text-xs mb-1">Desde Mes</label>
                            <select id="rangoInicioMes" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1">Desde Año</label>
                            <select id="rangoInicioAño" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1">Hasta Mes</label>
                            <select id="rangoFinMes" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1">Hasta Año</label>
                            <select id="rangoFinAño" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></select>
                        </div>
                    </div>
                    <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                        <div>
                            <label class="block text-xs mb-1">Formato</label>
                            <select id="formatoUnificado" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                                <option value="mensual">Mensual consolidado</option>
                                <option value="semanal">Semanal (paisaje)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button onclick="exportarPDFUnificado()" class="btn-primary py-2 rounded w-full md:w-auto"><i class="fas fa-file-pdf mr-2"></i>Exportar PDF Unificado</button>
                    </div>
                </div>

                <div class="card p-4 mb-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-users-cog mr-2"></i>Gestión de Usuarios
                    </h3>
                    <div id="usuariosManager" class="space-y-2"></div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                        <button onclick="agregarUsuario()" class="btn-secondary py-2 rounded"><i class="fas fa-user-plus mr-2"></i>Agregar Usuario</button>
                        <button onclick="guardarUsuarios()" class="btn-primary py-2 rounded"><i class="fas fa-save mr-2"></i>Guardar Usuarios</button>
                        <button onclick="previsualizarUsuario()" class="btn-secondary py-2 rounded"><i class="fas fa-eye mr-2"></i>Previsualizar Calendario</button>
                    </div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                        <button onclick="exportarPDFUsuarios()" class="btn-primary py-2 rounded"><i class="fas fa-file-pdf mr-2"></i>Exportar PDF (seleccionados)</button>
                        <button onclick="exportarPDFTodos()" class="btn-secondary py-2 rounded"><i class="fas fa-file-pdf mr-2"></i>Exportar PDF (todos)</button>
                    </div>
                </div>

                <div class="card p-4 mb-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-book mr-2"></i>Documentación Técnica (Usuarios y PDF)
                    </h3>
                    <div class="text-sm space-y-2">
                        <div><span class="font-semibold">Almacenamiento:</span> Usuarios en `localStorage: usuariosInd`; Turnos por usuario en `turnos_user_<id>`.</div>
                        <div><span class="font-semibold">Aislamiento:</span> El calendario opera sobre el usuario activo; cambiar de usuario carga sus datos sin afectar a los demás.</div>
                        <div><span class="font-semibold">Exportación PDF:</span> Botones generan PDF del mes seleccionado: uno por usuario (páginas múltiples) o todos.</div>
                        <div><span class="font-semibold">Preview:</span> Previsualiza el calendario del usuario activo en el modal integrado.</div>
                        <div><span class="font-semibold">API interna:</span> `guardarDatos` guarda en el perfil activo; `setUsuarioActivo(id)` intercambia el contexto; `dibujarCalendarioEnPDF(doc, año, mes, nombre, color)` dibuja una página.</div>
                        <div><span class="font-semibold">Unificado:</span> `exportarPDFUnificado()` genera un PDF con vista mensual consolidada y resumen por usuario entre un rango de fechas. Destaca feriados con fondo y nombre.</div>
                    </div>
                </div>

                <div class="card p-4 mb-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-image mr-2"></i>Vista Unificada (App) y JPG
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                        <div>
                            <label class="block text-xs mb-1">Formato</label>
                            <select id="vistaUnificadaFormato" class="rounded-lg border border-gray-300 dark:border-gray-700 p-2 text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                                <option value="semanal">Semanal</option>
                                <option value="mensual">Mensual</option>
                            </select>
                        </div>
                        <button onclick="renderUnificadoEnApp()" class="btn-primary py-2 rounded"><i class="fas fa-eye mr-2"></i>Generar Vista</button>
                        <button onclick="descargarUnificadoJPG()" class="btn-secondary py-2 rounded"><i class="fas fa-download mr-2"></i>Descargar JPG</button>
                    </div>
                    <div id="unificadoPreview" class="mt-3 overflow-auto">
                        <canvas id="unificadoCanvas" style="max-width:100%; height:auto; border:1px solid #333; border-radius:6px"></canvas>
                    </div>
                </div>
                

                <div class="card p-4 mb-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-forward mr-2"></i>Autocompletar Meses Siguientes
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Cantidad de Meses</label>
                            <input type="number" id="mesesAuto" min="1" max="24" value="6" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="sobrescribirAuto" class="mr-2">
                            <label for="sobrescribirAuto" class="text-sm">Sobrescribir meses con datos</label>
                        </div>
                        <div class="flex items-end">
                            <button onclick="autollenarSiguientesMeses()" class="btn-primary py-2 rounded w-full">
                                <i class="fas fa-magic mr-2"></i>Autocompletar
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="abrirPreviewAutollenado()" class="btn-secondary py-2 rounded w-full">
                                <i class="fas fa-eye mr-2"></i>Previsualizar Autocompletar
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="autollenarMesSiguiente()" class="btn-secondary py-2 rounded w-full">
                                <i class="fas fa-step-forward mr-2"></i>Autocompletar Mes Siguiente
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="autollenarAnual()" class="btn-primary py-2 rounded w-full">
                                <i class="fas fa-calendar-alt mr-2"></i>Autocompletar Año
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card p-4 mb-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-copy mr-2"></i>Copiar/Duplicar Mes
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Mes destino</label>
                            <select id="copyMonth" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Año destino</label>
                            <select id="copyYear" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="copyOverwrite" class="mr-2">
                            <label for="copyOverwrite" class="text-sm">Sobrescribir si existe</label>
                        </div>
                        <div class="flex items-end">
                            <button onclick="copiarMesActualAlDestino()" class="btn-primary py-2 rounded w-full">
                                <i class="fas fa-clone mr-2"></i>Copiar Mes
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card p-4 mb-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-edit mr-2"></i>Edición en Rango
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Inicio</label>
                            <input type="date" id="rangoInicio" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Fin</label>
                            <input type="date" id="rangoFin" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Turno</label>
                            <select id="rangoTurno" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                                <option value="dia">Día</option>
                                <option value="noche">Noche</option>
                                <option value="extra-dia">Extra Día</option>
                                <option value="extra-noche">Extra Noche</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Acción</label>
                            <select id="rangoAccion" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                                <option value="aplicar">Aplicar</option>
                                <option value="quitar">Quitar</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="editarTurnoEnRango()" class="btn-secondary py-2 rounded w-full">
                                <i class="fas fa-check mr-2"></i>Ejecutar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-configuracion" class="tab-content">
                <!-- Contenido de configuración -->
                <div class="card p-4 mb-4">
                    <h3 class="font-semibold text-lg mb-3">
                        <i class="fas fa-cogs mr-2"></i>Completar Calendario
                    </h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Patrón de Turnos</label>
                            <select id="patronSelect" onchange="toggleCustomPattern()" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                                <option value="4x4">4x4 (4 días trabajo, 4 descanso)</option>
                                <option value="5x2">5x2 (5 días trabajo, 2 descanso)</option>
                                <option value="7x7">7x7 (7 días trabajo, 7 descanso)</option>
                                <option value="6x3">6x3 (6 días trabajo, 3 descanso)</option>
                                <option value="3x3" selected>3x3 (3 días trabajo, 3 descanso)</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        
                        <div id="customPatternDiv" class="hidden grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium mb-1">Días de Trabajo</label>
                                <input type="number" id="diasTrabajo" min="1" max="30" value="3" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Días de Descanso</label>
                                <input type="number" id="diasDescanso" min="1" max="30" value="3" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Tipo de Rotación</label>
                            <select id="tipoRotacion" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                                <option value="solo-dia">Solo Día</option>
                                <option value="solo-noche">Solo Noche</option>
                                <option value="dia-noche">Alternando Día/Noche</option>
                                <option value="noche-noche-dia">Ciclo Noche-Noche-Día</option>
                                <option value="noche-dia-noche">Ciclo Noche-Día-Noche</option>
                                <option value="dia-noche-noche">Ciclo Día-Noche-Noche</option>
                                <option value="dia-dia-noche">Ciclo Día-Día-Noche</option>
                                <option value="dia-noche-dia">Ciclo Día-Noche-Día</option>
                                <option value="noche-dia-dia">Ciclo Noche-Día-Día</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Fecha de Inicio (opcional)</label>
                            <input type="date" id="fechaInicio" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                            <p class="text-xs text-gray-500 mt-1">Si no se especifica, se usará el primer día del mes.</p>
                        </div>
                        
                        <button onclick="completarCalendario()" class="btn-primary py-2 rounded">
                            <i class="fas fa-magic mr-2"></i>Completar Calendario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Variables globales
        let turnos = JSON.parse(localStorage.getItem('turnos')) || {};
        let diaSeleccionado = null;
        let feriadosCache = {};

        // Feriados de Chile
        const FERIADOS = {
            'Año Nuevo': año => ajustarFinSemana(new Date(año, 0, 1)),
            'Viernes Santo': año => calcularSemanaSanta(año, -2),
            'Sábado Santo': año => calcularSemanaSanta(año, -1),
            'Día del Trabajo': año => ajustarFinSemana(new Date(año, 4, 1)),
            'Glorias Navales': año => new Date(año, 4, 21),
            'San Pedro y Pablo': año => ultimoLunesDelMes(año, 5),
            'Virgen del Carmen': año => new Date(año, 6, 16),
            'Asunción': año => new Date(año, 7, 15),
            'Independencia': año => ajustarFinSemana(new Date(año, 8, 18)),
            'Ejército': año => ajustarFinSemana(new Date(año, 8, 19)),
            'Encuentro de Dos Mundos': año => segundoLunesOctubre(año),
            'Reforma Protestante': año => ajustarFinSemana(new Date(año, 9, 31)),
            'Inmaculada': año => ajustarFinSemana(new Date(año, 11, 8)),
            'Navidad': año => ajustarFinSemana(new Date(año, 11, 25))
        };

        // Funciones de utilidad para feriados
        function calcularSemanaSanta(año, diasDiferencia) {
            // Algoritmo de Butcher para calcular la Pascua
            const a = año % 19;
            const b = Math.floor(año / 100);
            const c = año % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const mes = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const dia = ((h + l - 7 * m + 114) % 31) + 1;
            
            const pascua = new Date(año, mes, dia);
            return new Date(pascua.getTime() + diasDiferencia * 24 * 60 * 60 * 1000);
        }

        function ajustarLunes(fecha) {
            const diaSemana = fecha.getDay();
            if (diaSemana === 0) {
                return new Date(fecha.getTime() + 24 * 60 * 60 * 1000);
            }
            return fecha;
        }

        function ajustarFinSemana(fecha) {
            return fecha;
        }

        function segundoLunesOctubre(año) {
            let fecha = new Date(año, 9, 1);
            let lunesContados = 0;
            while (true) {
                if (fecha.getDay() === 1) {
                    lunesContados++;
                    if (lunesContados === 2) return fecha;
                }
                fecha = new Date(fecha.getTime() + 24 * 60 * 60 * 1000);
            }
        }

        function ultimoLunesDelMes(año, mesIndex) {
            let fecha = new Date(año, mesIndex + 1, 0);
            while (fecha.getDay() !== 1) {
                fecha = new Date(fecha.getTime() - 24 * 60 * 60 * 1000);
            }
            return fecha;
        }

        function esFeriado(fecha) {
            const año = fecha.getFullYear();
            
            // Usar caché para mejorar rendimiento
            if (!feriadosCache[año]) {
                feriadosCache[año] = {};
                for (const [nombre, fn] of Object.entries(FERIADOS)) {
                    const fechaFeriado = fn(año);
                    feriadosCache[año][fechaFeriado.toDateString()] = nombre;
                }
            }
            
            return feriadosCache[año][fecha.toDateString()] || false;
        }

        // Marca el día actual en el calendario
        function marcarDiaActual() {
            const fechaActual = new Date();
            const diaActual = fechaActual.getDate();
            const mesActual = fechaActual.getMonth();
            const añoActual = fechaActual.getFullYear();
            
            // Quitar la clase 'today' de todos los días primero
            document.querySelectorAll('.today').forEach(el => {
                el.classList.remove('today');
            });
            
            // Marcar el día actual solo si estamos viendo el mes actual
            const mesSeleccionado = document.getElementById('monthSelect').value;
            const añoSeleccionado = document.getElementById('yearSelect').value;
            
            if (mesActual == mesSeleccionado && añoActual == añoSeleccionado) {
                const diaElemento = document.querySelector(`.day[data-dia="${diaActual}"][data-mes="${mesActual}"][data-anio="${añoActual}"]`);
                if (diaElemento) {
                    diaElemento.classList.add('today');
                }
            }
        }

        // Actualiza el calendario
        function actualizarCalendario() {
            const año = document.getElementById('yearSelect').value;
            const mes = document.getElementById('monthSelect').value;
            const fecha = new Date(año, mes, 1);
            const diasMes = new Date(año, parseInt(mes) + 1, 0).getDate();
            
            // Actualizar el título del mes
            document.getElementById('monthYear').textContent = 
                fecha.toLocaleDateString('es-CL', { month: 'long', year: 'numeric' }).toUpperCase();

            const calendario = document.getElementById('calendar');
            calendario.innerHTML = '';

            // Agregar los días de la semana
            const diasSemana = ['Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa', 'Do'];
            diasSemana.forEach((dia, idx) => {
                const divDiaSemana = document.createElement('div');
                divDiaSemana.className = 'day day-header';
                divDiaSemana.textContent = dia;
                if (idx >= 5) divDiaSemana.classList.add('weekend');
                calendario.appendChild(divDiaSemana);
            });

            // Añadir días vacíos para alinear el primer día
            const primerDiaSemana = (fecha.getDay() + 6) % 7; // Convertir a Lunes=0
            for(let i = 0; i < primerDiaSemana; i++) {
                const divVacio = document.createElement('div');
                divVacio.className = 'day empty-day';
                calendario.appendChild(divVacio);
            }

        // Agregar los días del mes
        for (let dia = 1; dia <= diasMes; dia++) {
                const fechaActual = new Date(año, mes, dia);
                const nombreFeriado = esFeriado(fechaActual);
                
                const divDia = document.createElement('div');
                divDia.className = 'day';
                divDia.setAttribute('data-dia', dia);
                divDia.setAttribute('data-mes', mes);
                divDia.setAttribute('data-anio', año);
                const dw = fechaActual.getDay();
                if (dw === 6) { divDia.classList.add('weekend','saturday'); }
                else if (dw === 0) { divDia.classList.add('weekend','sunday'); }
                if (nombreFeriado) { divDia.classList.add('holiday'); }
                
                // Tooltip para feriados
                const tooltip = nombreFeriado ? 
                    `<div class="tooltip">
                        <div class="feriado"></div>
                        <span class="tooltiptext">${nombreFeriado}</span>
                    </div>` : '';
                
                divDia.innerHTML = `
                    <div class="mobile-day-number">${dia}</div>
                    ${tooltip}
                    ${nombreFeriado ? '<span class="day-badge"><i class="fas fa-flag"></i></span>' : ''}
                `;

            // Agregar turnos si existen
            if (turnos[año]?.[mes]?.[dia]) {
                if (turnos[año][mes][dia].locked) {
                    divDia.classList.add('locked');
                    const lock = document.createElement('i');
                    lock.className = 'fas fa-lock lock-indicator';
                    divDia.appendChild(lock);
                }
                turnos[año][mes][dia].turnos.forEach(turno => {
                        // Para pantallas grandes: mostrar texto completo
                        const divTurno = document.createElement('div');
                        divTurno.className = `turno ${turno}`;
                        const icon = turno.includes('noche') ? 'fa-moon' : 'fa-sun';
                        const extraIcon = turno.includes('extra') ? '<i class="fas fa-plus"></i>' : '';
                        divTurno.innerHTML = `<i class="fas ${icon}"></i>${turno.replace('-', ' ').toUpperCase()} ${extraIcon}`;
                        divDia.appendChild(divTurno);
                        
                        // Para móviles: mostrar indicador visual
                        const divMobileIndicator = document.createElement('div');
                        divMobileIndicator.className = `mobile-turno-indicator mobile-${turno}`;
                        divDia.appendChild(divMobileIndicator);
                    });
                }

                divDia.onclick = () => abrirModal(dia);
                calendario.appendChild(divDia);
            }
            
            calcularHoras();
            calcularEstadisticas();
            marcarDiaActual();
            actualizarProgresoBloque();
            renderVistaAnual();
        }

        function cambiarMes(offset) {
            const yearEl = document.getElementById('yearSelect');
            const monthEl = document.getElementById('monthSelect');
            let y = parseInt(yearEl.value, 10);
            let m = parseInt(monthEl.value, 10);
            m += offset;
            if (m < 0) { m = 11; y -= 1; }
            if (m > 11) { m = 0; y += 1; }
            y = Math.min(2030, Math.max(1900, y));
            yearEl.value = y;
            monthEl.value = m;
            actualizarCalendario();
        }

        function cambiarAño(offset) {
            const yearEl = document.getElementById('yearSelect');
            let y = parseInt(yearEl.value, 10) + offset;
            y = Math.min(2030, Math.max(1900, y));
            yearEl.value = y;
            actualizarCalendario();
        }

        function goToToday() {
            const hoy = new Date();
            document.getElementById('yearSelect').value = hoy.getFullYear();
            document.getElementById('monthSelect').value = hoy.getMonth();
            actualizarCalendario();
        }

        function toggleMonthGrid() {
            const grid = document.getElementById('monthGrid');
            if (!grid) return;
            grid.classList.toggle('hidden');
        }

        function seleccionarMes(m) {
            document.getElementById('monthSelect').value = m;
            actualizarCalendario();
            const grid = document.getElementById('monthGrid');
            if (grid) grid.classList.add('hidden');
        }

        function toggleAnnualView() {
            const cont = document.getElementById('annualView');
            if (!cont) return;
            cont.classList.remove('hidden');
            const collapsed = cont.classList.toggle('annual-collapsed');
            localStorage.setItem('annualViewHidden', collapsed ? '1' : '0');
            const icon = document.getElementById('annualToggleIcon');
            if (icon) {
                icon.classList.remove('fa-eye', 'fa-eye-slash');
                icon.classList.add(collapsed ? 'fa-eye-slash' : 'fa-eye');
            }
            const monthly = document.getElementById('monthlyContainer');
            if (monthly) {
                monthly.classList.remove('md:col-span-2', 'md:col-span-3');
                monthly.classList.add(collapsed ? 'md:col-span-3' : 'md:col-span-2');
                monthly.classList.toggle('expanded', collapsed);
            }
        }

        function irAlProximoLibre() {
            const hoy = new Date();
            let y = hoy.getFullYear();
            let m = hoy.getMonth();
            let d = hoy.getDate();
            for (let offset = 0; offset < 24; offset++) {
                const yy = y + Math.floor((m + offset) / 12);
                const mm = (m + offset) % 12;
                const startDay = (offset === 0) ? d : 1;
                const diasMes = new Date(yy, mm + 1, 0).getDate();
                for (let dd = startDay; dd <= diasMes; dd++) {
                    const datosDia = turnos[yy]?.[mm]?.[dd];
                    const libre = !datosDia || !datosDia.turnos || datosDia.turnos.length === 0;
                    if (libre) {
                        document.getElementById('yearSelect').value = yy;
                        document.getElementById('monthSelect').value = mm;
                        actualizarCalendario();
                        const diaElemento = document.querySelector(`.day[data-dia="${dd}"][data-mes="${mm}"][data-anio="${yy}"]`);
                        if (diaElemento) {
                            diaElemento.style.border = '2px solid var(--primary)';
                            diaElemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        mostrarAlerta('Saltado al próximo día libre');
                        return;
                    }
                }
            }
            mostrarAlerta('No se encontró un día libre en los próximos 24 meses');
        }

        function toggleCompacto() {
            document.body.classList.toggle('compact-mode');
        }

        function irAlProximoTurno() {
            const hoy = new Date();
            let y = hoy.getFullYear();
            let m = hoy.getMonth();
            let d = hoy.getDate();
            for (let offset = 0; offset < 24; offset++) {
                const yy = y + Math.floor((m + offset) / 12);
                const mm = (m + offset) % 12;
                const startDay = (offset === 0) ? d : 1;
                const diasMes = new Date(yy, mm + 1, 0).getDate();
                for (let dd = startDay; dd <= diasMes; dd++) {
                    if (turnos[yy]?.[mm]?.[dd] && turnos[yy][mm][dd].turnos.length > 0) {
                        document.getElementById('yearSelect').value = yy;
                        document.getElementById('monthSelect').value = mm;
                        actualizarCalendario();
                        // Resaltar el día
                        document.querySelectorAll('.day-highlight').forEach(el => el.classList.remove('day-highlight'));
                        const diaElemento = document.querySelector(`.day[data-dia="${dd}"][data-mes="${mm}"][data-anio="${yy}"]`);
                        if (diaElemento) {
                            diaElemento.classList.add('day-highlight');
                            diaElemento.style.border = '2px solid var(--secondary)';
                            diaElemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        mostrarAlerta('Saltado al próximo turno');
                        return;
                    }
                }
            }
            mostrarAlerta('No se encontró un próximo turno en los próximos 24 meses');
        }

        function abrirPreviewAutollenado() {
            const añoActual = parseInt(document.getElementById('yearSelect').value);
            const mesActual = parseInt(document.getElementById('monthSelect').value);
            const deduccion = deducirConfiguracionDesdeMes(añoActual, mesActual);
            if (!deduccion) { mostrarAlerta('No hay patrón detectable en el mes actual'); return; }
            let estado = JSON.parse(JSON.stringify(deduccion.estadoSiguiente));
            const cfg = deduccion.config;
            const bloques = [];
            for (let i = 0; i < 4; i++) {
                if (estado.esTrabajo) {
                    const turno = cfg.partesRotacion[estado.subCicloIndex];
                    bloques.push(`Trabajo ${cfg.diasTrabajo} días — turno ${turno.toUpperCase()}`);
                    // Pasar a descanso
                    estado.esTrabajo = false;
                    estado.workPos = 0;
                    estado.restPos = 0;
                    estado.subCicloIndex = (estado.subCicloIndex + 1) % cfg.partesRotacion.length;
                    bloques.push(`Descanso ${cfg.diasDescanso} días`);
                } else {
                    bloques.push(`Descanso ${cfg.diasDescanso} días`);
                    estado.esTrabajo = true;
                    estado.workPos = 0;
                    estado.restPos = 0;
                }
            }
            const cont = document.getElementById('previewContent');
            if (cont) {
                cont.innerHTML = '<ul class="list-disc pl-5">' + bloques.map(b=>`<li>${b}</li>`).join('') + '</ul>';
            }
            const modal = document.getElementById('previewModal');
            if (modal) { modal.style.display='flex'; modal.classList.add('active'); }
        }

        function cerrarPreview() {
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(()=>{ modal.style.display='none'; }, 300);
            }
        }

        function importarDesdeJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const obj = JSON.parse(reader.result);
                    if (obj && obj.turnos) {
                        turnos = obj.turnos;
                        guardarDatos();
                        actualizarCalendario();
                        mostrarAlerta('Datos JSON importados');
                    } else {
                        mostrarAlerta('Archivo JSON no válido');
                    }
                } catch (e) {
                    mostrarAlerta('Error al leer JSON');
                }
            };
            reader.readAsText(file);
        }

        function copiarMesActualAlDestino() {
            const añoSrc = parseInt(document.getElementById('yearSelect').value);
            const mesSrc = parseInt(document.getElementById('monthSelect').value);
            const añoDst = parseInt(document.getElementById('copyYear').value);
            const mesDst = parseInt(document.getElementById('copyMonth').value);
            const overwrite = document.getElementById('copyOverwrite').checked;
            if (!turnos[añoSrc]?.[mesSrc]) { mostrarAlerta('El mes actual no tiene datos'); return; }
            if (!overwrite && turnos[añoDst]?.[mesDst]) { mostrarAlerta('Mes destino ya tiene datos'); return; }
            if (!turnos[añoDst]) turnos[añoDst] = {};
            turnos[añoDst][mesDst] = {};
            Object.entries(turnos[añoSrc][mesSrc]).forEach(([dia, datos]) => {
                turnos[añoDst][mesDst][dia] = {
                    turnos: [...(datos.turnos || [])],
                    nota: datos.nota || '',
                    locked: !!datos.locked
                };
            });
            guardarDatos();
            mostrarAlerta('Mes copiado al destino');
        }

        function editarTurnoEnRango() {
            const inicio = document.getElementById('rangoInicio').value;
            const fin = document.getElementById('rangoFin').value;
            const turno = document.getElementById('rangoTurno').value;
            const accion = document.getElementById('rangoAccion').value;
            if (!inicio || !fin) { mostrarAlerta('Selecciona fechas inicio y fin'); return; }
            const start = new Date(inicio);
            const end = new Date(fin);
            if (end < start) { mostrarAlerta('Rango inválido'); return; }
            let cursor = new Date(start);
            while (cursor <= end) {
                const y = cursor.getFullYear();
                const m = cursor.getMonth();
                const d = cursor.getDate();
                if (!turnos[y]) turnos[y] = {};
                if (!turnos[y][m]) turnos[y][m] = {};
                if (!turnos[y][m][d]) turnos[y][m][d] = { turnos: [], nota: '' };
                if (turnos[y][m][d].locked) { cursor.setDate(d+1); continue; }
                const list = turnos[y][m][d].turnos;
                if (accion === 'aplicar') {
                    if (!list.includes(turno)) list.push(turno);
                } else {
                    turnos[y][m][d].turnos = list.filter(t => t !== turno);
                    if (turnos[y][m][d].turnos.length === 0) delete turnos[y][m][d];
                }
                cursor.setDate(d+1);
            }
            guardarDatos();
            actualizarCalendario();
            mostrarAlerta('Edición en rango aplicada');
        }

        function actualizarProgresoBloque() {
            const cont = document.getElementById('progressBlock');
            if (!cont) return;
            const año = parseInt(document.getElementById('yearSelect').value);
            const mes = parseInt(document.getElementById('monthSelect').value);
            const deduccion = deducirConfiguracionDesdeMes(año, mes);
            if (!deduccion) { cont.innerHTML = '<div class="text-sm">Sin patrón detectado</div>'; return; }
            const hoy = new Date();
            const esMesActual = hoy.getFullYear() === año && hoy.getMonth() === mes;
            let estado = deduccion.estadoSiguiente;
            // Retroceder hasta el inicio del mes para conocer estado del día 1
            // Simplificación: mostrar info del siguiente bloque
            const tipo = estado.esTrabajo ? 'Trabajo' : 'Descanso';
            const dias = estado.esTrabajo ? deduccion.config.diasTrabajo : deduccion.config.diasDescanso;
            const html = `<div class="flex items-center gap-3"><span class="font-semibold">Siguiente bloque:</span><span>${tipo} (${dias} días)</span>${esMesActual?'<span class="text-xs text-gray-500">Mes actual</span>':''}</div>`;
            cont.innerHTML = html;
        }

        function renderVistaAnual() {
            const cont = document.getElementById('annualView');
            if (!cont) return;
            const año = parseInt(document.getElementById('yearSelect').value);
            let html = '<h3 class="font-semibold text-lg mb-3"><i class="fas fa-calendar"></i> Vista Anual</h3>';
            let totalNormales = 0;
            let totalExtras = 0;
            for (let mes = 0; mes < 12; mes++) {
                const diasMes = new Date(año, mes + 1, 0).getDate();
                let ocupados = 0;
                let normalesMes = 0;
                let extrasMes = 0;
                const mini = [];
                for (let d = 1; d <= diasMes; d++) {
                    const datos = turnos[año]?.[mes]?.[d];
                    const has = !!(datos && datos.turnos && datos.turnos.length > 0);
                    const extra = has && datos.turnos.some(t => t.includes('extra'));
                    if (has) ocupados++;
                    if (has) {
                        datos.turnos.forEach(t => {
                            if (t.includes('extra')) extrasMes += 12; else normalesMes += 12;
                        });
                    }
                    mini.push(`<div class="mini-day${has?' has':''}${extra?' extra':''}"></div>`);
                }
                totalNormales += normalesMes;
                totalExtras += extrasMes;
                const mesNombre = new Date(año, mes, 1).toLocaleDateString('es-CL', { month: 'short' }).toUpperCase();
                html += `<div class="mb-3"><div class="flex items-center justify-between mb-1"><span class="font-medium">${mesNombre}</span><span class="text-xs">${ocupados}/${diasMes} · ${normalesMes}h / ${extrasMes}h</span><button class="btn-secondary px-2 py-1 rounded text-xs" onclick="goToMonthFromAnnual(${mes})">Ir</button></div><div class="mini-calendar">${mini.join('')}</div></div>`;
            }
            html += `<div class="mt-3"><div class="flex items-center justify-between"><span class="font-medium">Total anual</span><span class="text-sm">${totalNormales}h normales / ${totalExtras}h extras</span></div></div>`;
            cont.innerHTML = html;
        }

        function goToMonthFromAnnual(m) {
            document.getElementById('monthSelect').value = m;
            actualizarCalendario();
        }

        

        

        

        // Abrir modal para agregar/quitar turnos
        function abrirModal(dia) {
            diaSeleccionado = dia;
            const año = document.getElementById('yearSelect').value;
            const mes = document.getElementById('monthSelect').value;
            
            // Limpiar nota anterior
            document.getElementById('nota').value = '';
            
            // Si hay datos para este día, cargar la nota
            if (turnos[año]?.[mes]?.[dia]?.nota) {
                document.getElementById('nota').value = turnos[año][mes][dia].nota;
            }
            
            const modal = document.getElementById('turnoModal');
            modal.style.display = 'flex';
            modal.classList.add('active');
        }

        // Cerrar modal
        function cerrarModal() {
            const modal = document.getElementById('turnoModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Agregar turno con validaciones
        function agregarTurno() {
            const año = document.getElementById('yearSelect').value;
            const mes = document.getElementById('monthSelect').value;
            const turno = document.getElementById('turnoSelect').value;
            const nota = document.getElementById('nota').value;

            if (!turnos[año]) turnos[año] = {};
            if (!turnos[año][mes]) turnos[año][mes] = {};
            if (!turnos[año][mes][diaSeleccionado]) {
                turnos[año][mes][diaSeleccionado] = { turnos: [], nota: '' };
            }
            if (turnos[año][mes][diaSeleccionado].locked) {
                mostrarAlerta('Día bloqueado: no se permiten cambios');
                return;
            }

            const turnosDia = turnos[año][mes][diaSeleccionado].turnos;
            
            // Validar combinaciones de turnos
            const normales = turnosDia.filter(t => !t.includes('extra'));
            const extras = turnosDia.filter(t => t.includes('extra'));

            if (turno.includes('extra')) {
                // Validar turno extra
                if (extras.length >= 1) {
                    mostrarAlerta('Solo se permite 1 turno extra por día');
                    return;
                }
                if (normales.length > 0 && !turno.includes(normales[0])) {
                    mostrarAlerta('El turno extra debe coincidir con el turno normal');
                    return;
                }
            } else {
                return renderUnificadoEnAppMensualStacked(allUsers, year, month, dpr);
                return renderUnificadoEnAppMensualStacked(allUsers, year, month, dpr);
                return renderUnificadoEnAppMensualStacked(allUsers, year, month, dpr);
                return renderUnificadoEnAppMensualStacked(allUsers, year, month, dpr);
                // Validar turno normal
                if (normales.length >= 1) {
                    mostrarAlerta('Solo se permite 1 turno normal por día');
                    return;
                }
                if (extras.length > 0 && !extras[0].includes(turno)) {
                    mostrarAlerta('El turno normal debe coincidir con el extra existente');
                    return;
                }
            }

            // Agregar el turno si pasa las validaciones
            if (!turnosDia.includes(turno)) {
                turnosDia.push(turno);
                turnos[año][mes][diaSeleccionado].nota = nota;
                const bloquear = document.getElementById('bloquearDia').checked;
                if (bloquear) turnos[año][mes][diaSeleccionado].locked = true;
                guardarDatos();
                actualizarCalendario();
                cerrarModal();
            } else {
                mostrarAlerta('Este turno ya está asignado para este día');
            }
        }
        function renderUnificadoEnAppMensualStacked(allUsers, year, month, dpr) {
            const canvas = document.getElementById('unificadoCanvas'); if (!canvas) return;
            const css = v => getComputedStyle(document.body).getPropertyValue(v).trim();
            const hexToRgb = h => { const s=h.replace('#',''); return { r: parseInt(s.slice(0,2),16), g: parseInt(s.slice(2,4),16), b: parseInt(s.slice(4,6),16) }; };
            const cDia = hexToRgb(css('--turno-dia')); const cNoche = hexToRgb(css('--turno-noche')); const cExtraDia = hexToRgb(css('--turno-extra-dia')); const cExtraNoche = hexToRgb(css('--turno-extra-noche'));
            const margin = 20; const gridX = margin; const gridW = 1200; const colW = gridW/7; const headerH = 30; const cellH = 120;
            const totalDays = new Date(year, month+1, 0).getDate(); const first = (new Date(year, month, 1).getDay()+6)%7; const rows = 6;
            const width = gridW + margin*2; const height = margin + 32 + headerH + rows*cellH + 20;
            canvas.width = width*dpr; canvas.height = height*dpr; canvas.style.width = width+'px'; canvas.style.height = 'auto';
            const ctx = canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,width,height);
            ctx.font = 'bold 18px Helvetica'; ctx.fillStyle = '#fff'; const tituloMes = new Date(year, month, 1).toLocaleDateString('es-CL', { month: 'long' }).toUpperCase(); ctx.textAlign='center'; ctx.fillText(`Calendario Unificado · ${tituloMes} ${year}`, width/2, margin);
            ctx.textAlign='left'; ctx.font='12px Helvetica';
            let lx=gridX; let ly=margin+32; const lineH=18;
            allUsers.forEach(u=>{ const ps=(u.nombre||'').trim().split(/\s+/); const nm=(ps[0]||'') + (ps.length>1 ? ' ' + (ps[ps.length-1]||'').charAt(0).toUpperCase()+'.' : ''); const col=hexToRgb(u.color||'#FFD180'); ctx.fillStyle=`rgb(${col.r},${col.g},${col.b})`; ctx.fillRect(lx, ly-10, 10, 10); ctx.fillStyle='#e0e0e0'; ctx.fillText(nm, lx+14, ly); lx += 14 + Math.max(40, ctx.measureText(nm).width + 10); if (lx > gridX + gridW - 120) { lx = gridX; ly += lineH; } });
            const days=['Lu','Ma','Mi','Ju','Vi','Sa','Do']; for(let i=0;i<7;i++){ const cx=gridX+i*colW+colW/2; ctx.fillStyle='#ccc'; ctx.textAlign='center'; ctx.fillText(days[i], cx, ly+20); }
            ctx.textAlign='left'; let y0=ly+20+headerH;
            const lumin = (r,g,b)=> 0.2126*r + 0.7152*g + 0.0722*b;
            for(let r=0;r<rows;r++){
                for(let c=0;c<7;c++){
                    const x=gridX+c*colW; const yCell=y0+r*cellH; ctx.strokeStyle='#3a3a3a'; ctx.strokeRect(x,yCell,colW,cellH);
                    const idx=r*7+c-first; if(idx>=0 && idx<totalDays){
                        const day=idx+1; const date=new Date(year,month,day);
                        ctx.font='11px Helvetica'; ctx.fillStyle='#999'; ctx.fillText(String(day), x+4, yCell+14);
                        const fer=esFeriado(date); if(fer){
                            ctx.font='10px Helvetica';
                            const tw = ctx.measureText(fer).width;
                            const padX = 6; const padY = 2;
                            const tagW = Math.min(colW-12, tw + padX*2);
                            const tagX = x + colW - tagW - 6;
                            const tagY = yCell + 2;
                            ctx.fillStyle = 'rgba(255,221,221,0.85)';
                            ctx.fillRect(tagX, tagY, tagW, 14);
                            ctx.fillStyle = '#c00';
                            ctx.textAlign = 'center';
                            ctx.fillText(fer, tagX + tagW/2, tagY + 10);
                            ctx.textAlign='left';
                        }
                        let chips=[]; allUsers.forEach(u=>{ const data=JSON.parse(localStorage.getItem(`turnos_user_${u.id}`)||'{}'); const tlist=(data[year]?.[month]?.[day]?.turnos)||[]; tlist.forEach(t=>{ let col; let abbr; if(t.includes('extra-noche')){ col=cExtraNoche; abbr='NE'; } else if(t.includes('extra-dia')){ col=cExtraDia; abbr='DE'; } else if(t.includes('noche')){ col=cNoche; abbr='N'; } else { col=cDia; abbr='D'; } const parts=(u.nombre||'').trim().split(/\s+/); const nm=(parts[0]||'') + (parts.length>1 ? ' ' + (parts[parts.length-1]||'').charAt(0).toUpperCase()+'.' : ''); chips.push({ nm, abbr, col, pr: abbr==='NE'||abbr==='DE'?2:(abbr==='N'?1:0) }); }); });
                        chips.sort((a,b)=> b.pr - a.pr || a.nm.localeCompare(b.nm));
                        const startX=x+6; const startY=yCell+34; const sq=8; const gapY=10; const nameFont='10px Helvetica';
                        const lineH2=Math.max(20, sq + gapY + 8); const maxLines=Math.floor((cellH - (startY - yCell) - 10)/lineH2); let overflow=0;
                        ctx.save(); ctx.beginPath(); ctx.rect(x+2, yCell+30, colW-4, cellH-32); ctx.clip();
                        ctx.textAlign='left'; ctx.textBaseline='top';
                        chips.forEach((ch,idx)=>{
                            if(idx>=maxLines){ overflow++; return; }
                            const ly2=startY + idx*lineH2;
                            ctx.fillStyle=`rgb(${ch.col.r},${ch.col.g},${ch.col.b})`;
                            ctx.fillRect(startX, ly2, sq, sq);
                            const tc=lumin(ch.col.r,ch.col.g,ch.col.b)>140?'#000':'#fff';
                            ctx.fillStyle=tc; ctx.font='10px Helvetica'; ctx.textAlign='center';
                            ctx.fillText(ch.abbr, startX+sq/2, ly2+2);
                            ctx.textAlign='left'; ctx.fillStyle='#e0e0e0'; ctx.font=nameFont;
                            ctx.fillText(ch.nm, startX+sq+6, ly2+1);
                        });
                        ctx.restore();
                        if(overflow>0){ ctx.font='11px Helvetica'; ctx.fillStyle='#999'; ctx.fillText(`+${overflow} más`, x+4, yCell+cellH-6); }
                    }
                }
                const yLine=y0+(r+1)*cellH; ctx.strokeStyle='rgba(140,140,140,0.6)'; ctx.setLineDash([4,3]); ctx.beginPath(); ctx.moveTo(gridX, yLine); ctx.lineTo(gridX+gridW, yLine); ctx.stroke(); ctx.setLineDash([]);
                const idxMon=r*7-first; const dayMon=(idxMon<0)?1:((idxMon>=totalDays)?totalDays:idxMon+1);
                const wNum=(function(d){ const t=new Date(d.getTime()); t.setHours(0,0,0,0); t.setDate(t.getDate()+3-((t.getDay()+6)%7)); const wk1=new Date(t.getFullYear(),0,4); return 1+Math.round(((t-wk1)/86400000-3+((wk1.getDay()+6)%7))/7); })(new Date(year, month, dayMon));
                ctx.font='10px Helvetica'; ctx.fillStyle='#cccccc'; ctx.textAlign='right'; ctx.fillText(`Semana ${wNum}`, gridX-4, yLine - cellH/2); ctx.textAlign='left';
            }
        }

        // Mostrar alerta estilizada
        function mostrarAlerta(mensaje) {
            const alerta = document.createElement('div');
            alerta.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
            alerta.textContent = mensaje;
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                alerta.classList.remove('animate-bounce');
                alerta.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => alerta.remove(), 300);
            }, 3000);
        }

        // Quitar turno
        function quitarTurno() {
            const año = document.getElementById('yearSelect').value;
            const mes = document.getElementById('monthSelect').value;
            const turno = document.getElementById('turnoSelect').value;

            if (turnos[año]?.[mes]?.[diaSeleccionado]) {
                if (turnos[año][mes][diaSeleccionado].locked) {
                    mostrarAlerta('Día bloqueado: no se permiten cambios');
                    cerrarModal();
                    return;
                }
                if (!turno.includes('extra')) {
                    // Quitar turno normal y su extra asociado si existe
                    turnos[año][mes][diaSeleccionado].turnos = turnos[año][mes][diaSeleccionado].turnos
                        .filter(t => t !== turno && t !== `extra-${turno}`);
                } else {
                    // Quitar solo el turno extra
                    turnos[año][mes][diaSeleccionado].turnos = turnos[año][mes][diaSeleccionado].turnos
                        .filter(t => t !== turno);
                }

                // Si no quedan turnos, eliminar el día
                if (turnos[año][mes][diaSeleccionado].turnos.length === 0) {
                    delete turnos[año][mes][diaSeleccionado];
                    
                    // Si no quedan días en el mes, eliminar el mes
                    if (Object.keys(turnos[año][mes]).length === 0) {
                        delete turnos[año][mes];
                        
                        // Si no quedan meses en el año, eliminar el año
                        if (Object.keys(turnos[año]).length === 0) {
                            delete turnos[año];
                        }
                    }
                }

                guardarDatos();
                actualizarCalendario();
            }
            cerrarModal();
        }

        // Calcular horas trabajadas
        function calcularHoras() {
            let normales = 0;
            let extras = 0;
            const año = document.getElementById('yearSelect').value;
            const mes = document.getElementById('monthSelect').value;
            const diasNormales = [];
            const diasExtras = [];

            if (turnos[año]?.[mes]) {
                Object.entries(turnos[año][mes]).forEach(([dia, datos]) => {
                    const fecha = new Date(año, mes, dia);
                    const nombreDia = fecha.toLocaleDateString('es-CL', { weekday: 'long' });
                    const fechaFormateada = fecha.toLocaleDateString('es-CL');

                    datos.turnos.forEach(turno => {
                        const esExtra = turno.includes('extra');
                        const tipoTurno = turno.includes('dia') ? 'Día' : 'Noche';
                        const infoTurno = `${nombreDia} (${fechaFormateada}) - ${tipoTurno}`;

                        if (esExtra) {
                            extras += 12;
                            diasExtras.push(infoTurno);
                        } else {
                            normales += 12;
                            diasNormales.push(infoTurno);
                        }
                    });
                });
            }

            document.getElementById('diasNormales').value = diasNormales.join('\n');
            document.getElementById('diasExtras').value = diasExtras.join('\n');
            document.getElementById('horasNormales').textContent = normales;
            document.getElementById('horasExtras').textContent = extras;
            document.getElementById('totalHoras').textContent = normales + extras;
        }

        // Calcular estadísticas
        function calcularEstadisticas() {
            const año = document.getElementById('yearSelect').value;
            const mes = document.getElementById('monthSelect').value;
            const diasMes = new Date(año, parseInt(mes) + 1, 0).getDate();

            let diasTrabajados = 0;
            let diasLibres = diasMes;

            if (turnos[año]?.[mes]) {
                diasTrabajados = Object.keys(turnos[año][mes]).length;
                diasLibres = diasMes - diasTrabajados;
            }

            document.getElementById('diasTrabajados').textContent = diasTrabajados;
            document.getElementById('diasLibres').textContent = diasLibres;
        }

        // Guardar datos en localStorage
        function guardarDatos() {
            localStorage.setItem('turnos', JSON.stringify(turnos));
            try {
                const active = obtenerUsuarioActivo();
                if (active) {
                    localStorage.setItem(`turnos_user_${active.id}`, JSON.stringify(turnos));
                }
            } catch {}
        }

        

        // Copiar días normales al portapapeles
        function copiarNormales() {
            const texto = document.getElementById('diasNormales').value;
            if (!texto) {
                mostrarAlerta('No hay días normales para copiar');
                return;
            }
            
            navigator.clipboard.writeText(texto)
                .then(() => mostrarAlerta('Días normales copiados'))
                .catch(() => mostrarAlerta('Error al copiar'));
        }

        // Copiar días extras al portapapeles
        function copiarExtras() {
            const texto = document.getElementById('diasExtras').value;
            if (!texto) {
                mostrarAlerta('No hay días extras para copiar');
                return;
            }
            
            navigator.clipboard.writeText(texto)
                .then(() => mostrarAlerta('Días extras copiados'))
                .catch(() => mostrarAlerta('Error al copiar'));
        }

        // Limpiar el mes actual
        function limpiarMes() {
            const año = document.getElementById('yearSelect').value;
            const mes = document.getElementById('monthSelect').value;
            
            if (confirm('¿Estás seguro de que quieres limpiar todos los turnos de este mes?')) {
                if (turnos[año]?.[mes]) {
                    delete turnos[año][mes];
                    
                    // Si no quedan meses en el año, eliminar el año
                    if (Object.keys(turnos[año]).length === 0) {
                        delete turnos[año];
                    }
                    
                    guardarDatos();
                    actualizarCalendario();
                    mostrarAlerta('Mes limpiado correctamente');
                } else {
                    mostrarAlerta('No hay datos para limpiar este mes');
                }
            }
        }

        // Mantener siempre modo oscuro
        function cambiarTema() {
            document.body.classList.add('dark-mode');
            localStorage.setItem('tema', 'oscuro');
            const icono = document.querySelector('[onclick="cambiarTema()"] i');
            if (icono) { icono.classList.remove('fa-moon'); icono.classList.add('fa-sun'); }
            actualizarCalendario();
        }

        // Exportar a PDF
        function exportarAPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const año = parseInt(document.getElementById('yearSelect').value, 10);
            const mes = parseInt(document.getElementById('monthSelect').value, 10);
            const nombreMes = new Date(año, mes, 1).toLocaleDateString('es-CL', { month: 'long' });
            const titulo = `Calendario de Turnos - ${nombreMes.toUpperCase()} ${año}`;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text(titulo, 105, 15, { align: 'center' });
            const pageW = doc.internal.pageSize.getWidth();
            const margin = 10;
            const gridX = margin;
            const gridY = 25;
            const gridW = pageW - margin * 2;
            const colW = gridW / 7;
            const headerH = 10;
            const cellH = 25;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const diasSemana = ['Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa', 'Do'];
            for (let i = 0; i < 7; i++) {
                const cx = gridX + i * colW + colW / 2;
                doc.text(diasSemana[i], cx, gridY + 7, { align: 'center' });
            }
            const primerDiaSemana = (new Date(año, mes, 1).getDay() + 6) % 7;
            const diasMes = new Date(año, mes + 1, 0).getDate();
            const css = v => getComputedStyle(document.body).getPropertyValue(v).trim();
            const hexToRgb = h => { const s = h.replace('#',''); return { r: parseInt(s.slice(0,2),16), g: parseInt(s.slice(2,4),16), b: parseInt(s.slice(4,6),16) }; };
            const cDia = hexToRgb(css('--turno-dia'));
            const cNoche = hexToRgb(css('--turno-noche'));
            const cExtraDia = hexToRgb(css('--turno-extra-dia'));
            const cExtraNoche = hexToRgb(css('--turno-extra-noche'));
            const cHoliday = { r: 255, g: 220, b: 220 };
            const cSaturday = { r: 215, g: 235, b: 255 };
            const cSunday = { r: 255, g: 230, b: 230 };
            doc.setDrawColor(58, 58, 58);
            for (let r = 0; r < 6; r++) {
                for (let c = 0; c < 7; c++) {
                    const x = gridX + c * colW;
                    const y = gridY + headerH + r * cellH;
                    const idx = r * 7 + c - primerDiaSemana;
                    if (idx >= 0 && idx < diasMes) {
                        const day = idx + 1;
                        const dw = new Date(año, mes, day).getDay();
                        const fer = esFeriado(new Date(año, mes, day));
                        if (fer) { doc.setFillColor(cHoliday.r, cHoliday.g, cHoliday.b); doc.rect(x, y, colW, cellH, 'F'); }
                        else if (dw === 6) { doc.setFillColor(cSaturday.r, cSaturday.g, cSaturday.b); doc.rect(x, y, colW, cellH, 'F'); }
                        else if (dw === 0) { doc.setFillColor(cSunday.r, cSunday.g, cSunday.b); doc.rect(x, y, colW, cellH, 'F'); }
                    }
                    doc.rect(x, y, colW, cellH);
                    if (idx >= 0 && idx < diasMes) {
                        const day = idx + 1;
                        doc.text(String(day), x + 2, y + 6);
                        const fer = esFeriado(new Date(año, mes, day)); if (fer) { doc.setFontSize(7); doc.text(fer, x + colW - 2, y + 6, { align: 'right' }); doc.setFontSize(10); }
                        const tlist = (turnos[año]?.[mes]?.[day]?.turnos) || [];
                        const labels = tlist.slice(0, 3).map(t => {
                            if (t.includes('extra-noche')) return 'Noche Extra';
                            if (t.includes('extra-dia')) return 'Día Extra';
                            if (t.includes('noche')) return 'Noche';
                            return 'Día';
                        });
                        doc.setFontSize(8);
                        labels.forEach((lb, i) => { doc.text(lb, x + 2, y + 12 + i * 5); });
                        doc.setFontSize(10);
                        const bars = tlist.slice(0, 3);
                        const barH = 4;
                        const pad = 2;
                        let startY = y + cellH - pad - barH * bars.length - (bars.length - 1);
                        bars.forEach((turno, i) => {
                            let col;
                            if (turno.includes('extra-noche')) col = cExtraNoche;
                            else if (turno.includes('extra-dia')) col = cExtraDia;
                            else if (turno.includes('noche')) col = cNoche;
                            else col = cDia;
                            doc.setFillColor(col.r, col.g, col.b);
                            doc.roundedRect(x + 2, startY + i * (barH + 1), colW - 4, barH, 1, 1, 'F');
                        });
                    }
                }
            }
            doc.save(`turnos_${mes + 1}_${año}.pdf`);
        }

        // Gestión de usuarios independientes
        let usuariosInd = [];
        function cargarUsuarios() {
            const raw = localStorage.getItem('usuariosInd');
            usuariosInd = raw ? JSON.parse(raw) : [{ id: 'u1', nombre: 'Perfil 1', color: '#FFD180', seleccionado: true, activo: true }];
        }
        function guardarUsuarios() {
            localStorage.setItem('usuariosInd', JSON.stringify(usuariosInd));
        }
        function obtenerUsuarioActivo() {
            return usuariosInd.find(u => u.activo);
        }
        function setUsuarioActivo(id) {
            usuariosInd.forEach(u => u.activo = (u.id === id));
            const data = localStorage.getItem(`turnos_user_${id}`);
            turnos = data ? JSON.parse(data) : {};
            actualizarCalendario();
            guardarUsuarios();
            renderUsuariosSwitcher();
        }
        function agregarUsuario() {
            const idx = usuariosInd.length + 1;
            const id = `u${idx}_${Date.now()}`;
            const palette = ['#FFD180','#E4956C','#D16F40','#FFCC80','#B85C38','#8D4A29'];
            const color = palette[(idx-1) % palette.length];
            usuariosInd.push({ id, nombre: `Perfil ${idx}`, color, seleccionado: false, activo: false });
            renderUsuariosManager();
            guardarUsuarios();
            renderUsuariosSwitcher();
        }
        function eliminarUsuario(id) {
            const wasActive = usuariosInd.find(u=>u.id===id)?.activo;
            usuariosInd = usuariosInd.filter(u => u.id !== id);
            localStorage.removeItem(`turnos_user_${id}`);
            if (wasActive && usuariosInd.length) setUsuarioActivo(usuariosInd[0].id);
            renderUsuariosManager();
            guardarUsuarios();
            renderUsuariosSwitcher();
        }
        function toggleSeleccion(id, checked) {
            const u = usuariosInd.find(x => x.id === id); if (u) u.seleccionado = checked; guardarUsuarios();
        }
        function actualizarNombreColor(id, field, value) {
            const u = usuariosInd.find(x => x.id === id); if (!u) return; u[field] = value; guardarUsuarios(); renderUsuariosManager(); renderUsuariosSwitcher();
        }
        function renderUsuariosSwitcher() {
            const sel = document.getElementById('userSwitcher'); if (!sel) return;
            const edited = usuariosInd.filter(u => !/^Perfil\s+\d+$/i.test((u.nombre||'').trim()));
            sel.innerHTML = edited.map(u => `<option value="${u.id}" ${u.activo?'selected':''}>${u.nombre}</option>`).join('');
            sel.onchange = (e) => setUsuarioActivo(e.target.value);
            const active = obtenerUsuarioActivo();
            const sw = document.getElementById('userSwitcherColor'); if (sw) sw.style.background = active ? active.color : 'transparent';
        }
        function renderUsuariosManager() {
            const cont = document.getElementById('usuariosManager'); if (!cont) return;
            cont.innerHTML = usuariosInd.map(u => `
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-center">
                    <label class="inline-flex items-center gap-2"><input type="radio" name="usuarioActivo" ${u.activo?'checked':''} onclick="setUsuarioActivo('${u.id}')"><span>Activo</span></label>
                    <input class="p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700" value="${u.nombre}" onchange="actualizarNombreColor('${u.id}','nombre', this.value)">
                    <input type="color" value="${u.color}" onchange="actualizarNombreColor('${u.id}','color', this.value)">
                    <label class="inline-flex items-center gap-2"><input type="checkbox" ${u.seleccionado?'checked':''} onchange="toggleSeleccion('${u.id}', this.checked)"><span>Seleccionar para PDF</span></label>
                    <button class="bg-red-500 hover:bg-red-600 text-white py-2 rounded" onclick="eliminarUsuario('${u.id}')"><i class="fas fa-trash mr-2"></i>Eliminar</button>
                </div>`).join('');
        }
        function previsualizarUsuario() {
            const active = obtenerUsuarioActivo(); if (!active) return;
            const titulo = document.querySelector('#previewModal .modal-content h3'); if (titulo) titulo.textContent = `Previsualización de Calendario · ${active.nombre}`;
            const actions = document.querySelector('#previewModal .grid'); if (actions) actions.style.display = 'none';
            const y = parseInt(document.getElementById('yearSelect').value); const m = parseInt(document.getElementById('monthSelect').value);
            const cont = document.getElementById('previewContent'); if (!cont) return;
            const dias = new Date(y, m+1, 0).getDate(); const first = (new Date(y,m,1).getDay()+6)%7;
            const asignMes = turnos[y]?.[m] || {};
            let html = '<div class="grid grid-cols-7 gap-1">'+['Lu','Ma','Mi','Ju','Vi','Sa','Do'].map(d=>`<div class="text-center text-xs">${d}</div>`).join('');
            html += Array(first).fill('<div></div>').join('');
            for(let d=1; d<=dias; d++){ const t = asignMes[d]?.turnos||[]; const lbl = t.map(x=> x.includes('extra')? (x.includes('dia')?'Día Extra':'Noche Extra') : (x.includes('dia')?'Día':'Noche')).join('<br>'); html += `<div class="p-1 border border-gray-700 rounded"><div class="text-xs font-semibold">${d}</div><div class="text-[10px]">${lbl}</div></div>`; }
            html += '</div>';
            cont.innerHTML = html; document.getElementById('previewModal').style.display='flex'; setTimeout(()=>document.getElementById('previewModal').classList.add('active'),10);
        }
        function exportarPDFUsuarios() {
            const sel = usuariosInd.filter(u=>u.seleccionado);
            if (sel.length===0) { mostrarAlerta('Seleccione al menos un usuario'); return; }
            const backup = JSON.stringify(turnos);
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); let page = 0;
            const ySel = parseInt(document.getElementById('yearSelect').value); const mSel = parseInt(document.getElementById('monthSelect').value);
            sel.forEach((u, idx)=>{
                const raw = localStorage.getItem(`turnos_user_${u.id}`); turnos = raw ? JSON.parse(raw) : {};
                if (idx>0) { doc.addPage(); }
                dibujarCalendarioEnPDF(doc, ySel, mSel, u.nombre, u.color);
                page++;
            });
            doc.save(`calendarios_${mSel+1}_${ySel}.pdf`);
            turnos = JSON.parse(backup); actualizarCalendario();
        }
        function exportarPDFTodos() {
            usuariosInd.forEach(u => u.seleccionado = true); guardarUsuarios(); exportarPDFUsuarios();
        }
        function dibujarCalendarioEnPDF(doc, año, mes, tituloNombre, colorTitulo) {
            const nombreMes = new Date(año, mes, 1).toLocaleDateString('es-CL', { month: 'long' }).toUpperCase();
            doc.setFont('helvetica','bold'); doc.setFontSize(16);
            doc.text(`Calendario · ${tituloNombre} · ${nombreMes} ${año}`, 105, 12, { align: 'center' });
            const pageW = doc.internal.pageSize.getWidth(); const margin=10; const gridX=margin; const gridY=18; const gridW=pageW-margin*2; const colW=gridW/7; const headerH=8; const cellH=32;
            doc.setFont('helvetica','normal'); doc.setFontSize(9);
            ['Lu','Ma','Mi','Ju','Vi','Sa','Do'].forEach((d,i)=>{ const cx=gridX+i*colW+colW/2; doc.text(d,cx,gridY+6,{align:'center'}); });
            const first=(new Date(año,mes,1).getDay()+6)%7; const total=new Date(año,mes+1,0).getDate(); doc.setDrawColor(58,58,58);
            const css = v => getComputedStyle(document.body).getPropertyValue(v).trim();
            const hexToRgb = h => { const s = h.replace('#',''); return { r: parseInt(s.slice(0,2),16), g: parseInt(s.slice(2,4),16), b: parseInt(s.slice(4,6),16) }; };
            const cDia = hexToRgb(css('--turno-dia'));
            const cNoche = hexToRgb(css('--turno-noche'));
            const cExtraDia = hexToRgb(css('--turno-extra-dia'));
            const cExtraNoche = hexToRgb(css('--turno-extra-noche'));
            const cHoliday = { r: 255, g: 220, b: 220 };
            const cSaturday = { r: 215, g: 235, b: 255 };
            const cSunday = { r: 255, g: 230, b: 230 };
            for(let r=0;r<6;r++){
                for(let c=0;c<7;c++){
                    const x=gridX+c*colW; const y0=gridY+headerH+r*cellH; const idx=r*7+c-first; if(idx>=0 && idx<total){ const day=idx+1; const dw=new Date(año,mes,day).getDay(); const fer=esFeriado(new Date(año,mes,day)); if (fer){ doc.setFillColor(cHoliday.r,cHoliday.g,cHoliday.b); doc.rect(x,y0,colW,cellH,'F'); } else if (dw===6){ doc.setFillColor(cSaturday.r,cSaturday.g,cSaturday.b); doc.rect(x,y0,colW,cellH,'F'); } else if (dw===0){ doc.setFillColor(cSunday.r,cSunday.g,cSunday.b); doc.rect(x,y0,colW,cellH,'F'); } }
                    doc.rect(x,y0,colW,cellH);
                    if(idx>=0 && idx<total){ const day=idx+1; doc.text(String(day), x+2, y0+6); const fer=esFeriado(new Date(año,mes,day)); if (fer){ doc.setFontSize(7); doc.text(fer, x+colW-2, y0+6, {align:'right'}); doc.setFontSize(9); }
                        const tlist=(turnos[año]?.[mes]?.[day]?.turnos)||[]; const labels=tlist.slice(0,3).map(t=>{ if(t.includes('extra-noche')) return 'Noche Extra'; if(t.includes('extra-dia')) return 'Día Extra'; if(t.includes('noche')) return 'Noche'; return 'Día'; }); doc.setFontSize(8); labels.forEach((lb,i)=>{ const yy=y0+10+i*5; doc.text(lb, x+2, yy); }); doc.setFontSize(9); const bars=tlist.slice(0,3); const barH=4; const pad=2; let startY=y0+cellH-pad-barH*bars.length-(bars.length-1); bars.forEach((turno,i)=>{ let col; if(turno.includes('extra-noche')) col=cExtraNoche; else if(turno.includes('extra-dia')) col=cExtraDia; else if(turno.includes('noche')) col=cNoche; else col=cDia; doc.setFillColor(col.r,col.g,col.b); doc.roundedRect(x+2, startY+i*(barH+1), colW-4, barH, 1, 1, 'F'); }); }
                }
            }
        }

        function exportarPDFUnificado() {
            const formato = (document.getElementById('formatoUnificado')?.value || 'mensual');
            if (formato === 'semanal') { exportarPDFUnificadoSemanal(); return; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const now = new Date();
            const y0 = parseInt(document.getElementById('rangoInicioAño').value || document.getElementById('yearSelect').value);
            const m0 = parseInt(document.getElementById('rangoInicioMes').value || document.getElementById('monthSelect').value);
            const y1 = parseInt(document.getElementById('rangoFinAño').value || document.getElementById('yearSelect').value);
            const m1 = parseInt(document.getElementById('rangoFinMes').value || document.getElementById('monthSelect').value);
            const edited = usuariosInd.filter(u => !/^Perfil\s+\d+$/i.test((u.nombre||'').trim()));
            const allUsers = edited.length ? edited : usuariosInd;
            doc.setProperties({ title: 'Calendario Unificado', subject: 'Unificado por usuarios', creator: 'Calendario de Turnos', author: 'Sistema', keywords: 'turnos, calendario, PDF' });
            doc.setFont('helvetica','bold'); doc.setFontSize(16);
            doc.text(`Calendario Unificado`, 105, 12, { align: 'center' });
            doc.setFont('helvetica','normal'); doc.setFontSize(10);
            doc.text(`Generado: ${now.toLocaleString('es-CL')}`, 10, 20);
            let pages = 1;
            const resumen = allUsers.map(u => ({ id:u.id, nombre:u.nombre, color:u.color, dia:0, noche:0, extraDia:0, extraNoche:0 }));
            const monthsInRange = [];
            let cy=y0, cm=m0; while (cy<y1 || (cy===y1 && cm<=m1)) { monthsInRange.push({a:cy,m:cm}); cm++; if(cm>11){ cm=0; cy++; } }
            const css = v => getComputedStyle(document.body).getPropertyValue(v).trim();
            const hexToRgb = h => { const s=h.replace('#',''); return { r: parseInt(s.slice(0,2),16), g: parseInt(s.slice(2,4),16), b: parseInt(s.slice(4,6),16) }; };
            const cDia = hexToRgb(css('--turno-dia')); const cNoche = hexToRgb(css('--turno-noche')); const cExtraDia = hexToRgb(css('--turno-extra-dia')); const cExtraNoche = hexToRgb(css('--turno-extra-noche'));
            let legendY = 28; let lx=10;
            allUsers.forEach(u=>{ doc.setFillColor(...Object.values(hexToRgb(u.color||'#FFD180'))); doc.rect(lx, legendY-4, 6, 6, 'F'); doc.text(u.nombre, lx+8, legendY); lx += Math.max(60, (u.nombre||'').length*4); if (lx>180){ legendY+=8; lx=10; } });
            doc.setFillColor(255,220,220); doc.rect(10, legendY+4, 6, 6, 'F'); doc.text('Feriado', 18, legendY+8);
            doc.setFillColor(215,235,255); doc.rect(60, legendY+4, 6, 6, 'F'); doc.text('Sábado', 68, legendY+8);
            doc.setFillColor(255,230,230); doc.rect(110, legendY+4, 6, 6, 'F'); doc.text('Domingo', 118, legendY+8);
            monthsInRange.forEach((mm, idx)=>{
                if (idx>0) { doc.addPage(); pages++; }
                dibujarMesUnificadoEnPDF(doc, mm.a, mm.m, allUsers, resumen, { cDia, cNoche, cExtraDia, cExtraNoche });
            });
            doc.addPage(); pages++;
            doc.setFont('helvetica','bold'); doc.setFontSize(14);
            doc.text('Resumen por Usuario', 105, 15, { align: 'center' });
            doc.setFont('helvetica','normal'); doc.setFontSize(10);
            let y=24; resumen.forEach(r=>{ doc.setFillColor(...Object.values(hexToRgb(allUsers.find(u=>u.id===r.id)?.color||'#FFD180'))); doc.rect(10, y-4, 6, 6, 'F'); doc.text(`${r.nombre} · Día: ${r.dia} · Noche: ${r.noche} · Extra Día: ${r.extraDia} · Extra Noche: ${r.extraNoche}`, 18, y); y+=8; });
            const totalPages = doc.getNumberOfPages();
            for (let i=1; i<=totalPages; i++) { doc.setPage(i); doc.setFontSize(9); doc.text(`Página ${i} / ${totalPages}`, 200-10, 290); }
            if (totalPages>0) { mostrarAlerta(`PDF unificado generado: ${totalPages} páginas`); doc.save(`calendario_unificado_${y0}-${m0+1}_a_${y1}-${m1+1}.pdf`); } else { mostrarAlerta('No se generó contenido para el rango seleccionado'); }
        }
        function exportarPDFUnificadoSemanal() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' });
            const now = new Date();
            const y0 = parseInt(document.getElementById('rangoInicioAño').value || document.getElementById('yearSelect').value);
            const m0 = parseInt(document.getElementById('rangoInicioMes').value || document.getElementById('monthSelect').value);
            const y1 = parseInt(document.getElementById('rangoFinAño').value || document.getElementById('yearSelect').value);
            const m1 = parseInt(document.getElementById('rangoFinMes').value || document.getElementById('monthSelect').value);
            const edited = usuariosInd.filter(u => !/^Perfil\s+\d+$/i.test((u.nombre||'').trim()));
            const allUsers = edited.length ? edited : usuariosInd;
            doc.setProperties({ title: 'Calendario Unificado (Semanal)', subject: 'Matriz semanal por usuarios', creator: 'Calendario de Turnos' });
            const css = v => getComputedStyle(document.body).getPropertyValue(v).trim();
            const hexToRgb = h => { const s=h.replace('#',''); return { r: parseInt(s.slice(0,2),16), g: parseInt(s.slice(2,4),16), b: parseInt(s.slice(4,6),16) }; };
            const cDia = hexToRgb(css('--turno-dia')); const cNoche = hexToRgb(css('--turno-noche')); const cExtraDia = hexToRgb(css('--turno-extra-dia')); const cExtraNoche = hexToRgb(css('--turno-extra-noche'));
            const monthsInRange = []; let cy=y0, cm=m0; while (cy<y1 || (cy===y1 && cm<=m1)) { monthsInRange.push({a:cy,m:cm}); cm++; if(cm>11){ cm=0; cy++; } }
            const daysNames = ['Lu','Ma','Mi','Ju','Vi','Sa','Do'];
            if (fmt==='mensual') {
                return renderUnificadoEnAppMensualStacked(allUsers, year, month, dpr);
            }
            monthsInRange.forEach((mm, idxM)=>{
                const total = new Date(mm.a, mm.m+1, 0).getDate();
                const weeks = {};
                for(let d=1; d<=total; d++){ const dt=new Date(mm.a, mm.m, d); const wk = (function(){ const t=new Date(dt.getTime()); t.setHours(0,0,0,0); t.setDate(t.getDate()+3-((t.getDay()+6)%7)); const wk1=new Date(t.getFullYear(),0,4); return 1+Math.round(((t-wk1)/86400000-3+((wk1.getDay()+6)%7))/7); })(); if(!weeks[wk]) weeks[wk]=[]; weeks[wk].push({ d, dow:(dt.getDay()+6)%7, date:dt }); }
                const wkNums = Object.keys(weeks).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
                wkNums.forEach((wkNum, idxW)=>{
                    if (idxM>0 || idxW>0) doc.addPage();
                    const pageW = doc.internal.pageSize.getWidth(); const pageH = doc.internal.pageSize.getHeight(); const margin = 10;
                    const gridX = margin + 25; const gridY = 26; const gridW = pageW - margin*2 - 25; const colW = gridW/7; const headerH = 10; const rowH = Math.max(10, Math.min(16, Math.floor((pageH - gridY - 20)/ (allUsers.length+1))));
                    doc.setFont('helvetica','bold'); doc.setFontSize(14);
                    const tituloMes = new Date(mm.a, mm.m, 1).toLocaleDateString('es-CL', { month: 'long' }).toUpperCase();
                    doc.text(`Semana ${wkNum} · ${tituloMes} ${mm.a}`, pageW/2, 14, { align:'center' });
                    doc.setFont('helvetica','normal'); doc.setFontSize(9);
                    daysNames.forEach((n,i)=>{ const cx=gridX+i*colW+colW/2; doc.text(n, cx, gridY+7, { align:'center' }); });
                    doc.setDrawColor(58,58,58);
                    for(let i=0;i<7;i++){ const x=gridX+i*colW; const y=gridY+headerH; const h=rowH*(allUsers.length+1); const dow=i; if(dow===5){ doc.setFillColor(215,235,255); doc.rect(x,y,colW,h,'F'); } else if(dow===6){ doc.setFillColor(255,230,230); doc.rect(x,y,colW,h,'F'); } doc.rect(x,y,colW,h); }
                    doc.setFontSize(8);
                    weeks[wkNum].forEach(obj=>{ const x=gridX+obj.dow*colW; doc.text(String(obj.d), x+2, gridY+headerH-2); const fer = esFeriado(obj.date); if (fer) { doc.setFontSize(7); doc.text(fer, x+colW-2, gridY+headerH-2, { align:'right' }); doc.setFontSize(8); } });
                    doc.setFontSize(9);
                    const nameX = margin; const nameW = 24;
                    allUsers.forEach((u,ri)=>{ const ry = gridY+headerH + (ri+1)*rowH; const parts=(u.nombre||'').trim().split(/\s+/); const short=(parts[0]||'') + (parts.length>1 ? ' ' + (parts[parts.length-1]||'').charAt(0).toUpperCase()+'.' : ''); doc.text(short, nameX, ry- rowH/2 + 4); for(let i=0;i<7;i++){ const x=gridX+i*colW; const y=gridY+headerH + ri*rowH; doc.rect(x,y,colW,rowH); const dt = weeks[wkNum].find(xx=>xx.dow===i); if (!dt) continue; const tlist=(JSON.parse(localStorage.getItem(`turnos_user_${u.id}`)||'{}')[mm.a]?.[mm.m]?.[dt.d]?.turnos)||[]; const items=tlist.slice(0,4); const sq=5; let cx=x+2; const cy=y+rowH/2; items.forEach(t=>{ let col; let abbr; if(t.includes('extra-noche')){ col=cExtraNoche; abbr='NE'; } else if(t.includes('extra-dia')){ col=cExtraDia; abbr='DE'; } else if(t.includes('noche')){ col=cNoche; abbr='N'; } else { col=cDia; abbr='D'; } doc.setFillColor(col.r,col.g,col.b); doc.rect(cx, cy- sq/2, sq, sq, 'F'); doc.setTextColor(255,255,255); doc.text(abbr, cx+sq/2, cy+1.2, { align:'center' }); doc.setTextColor(0,0,0); cx += sq + 3; }); } });
                    doc.setFontSize(8); doc.text(`Generado: ${now.toLocaleString('es-CL')}`, margin, pageH-8);
                });
            });
            const totalPages = doc.getNumberOfPages(); for(let i=1;i<=totalPages;i++){ doc.setPage(i); doc.setFontSize(8); doc.text(`Página ${i} / ${totalPages}`, doc.internal.pageSize.getWidth()-12, doc.internal.pageSize.getHeight()-8, { align:'right' }); }
            doc.save('calendario_unificado_semanal.pdf');
        }

        function renderUnificadoEnApp() {
            const fmt = (document.getElementById('vistaUnificadaFormato')?.value || 'semanal');
            const canvas = document.getElementById('unificadoCanvas'); if (!canvas) return;
            const dpr = Math.max(2, Math.ceil(window.devicePixelRatio || 1));
            const year = parseInt(document.getElementById('yearSelect').value);
            const month = parseInt(document.getElementById('monthSelect').value);
            const edited = usuariosInd.filter(u => !/^Perfil\s+\d+$/i.test((u.nombre||'').trim()));
            const allUsers = edited.length ? edited : usuariosInd;
            const css = v => getComputedStyle(document.body).getPropertyValue(v).trim();
            const hexToRgb = h => { const s=h.replace('#',''); return { r: parseInt(s.slice(0,2),16), g: parseInt(s.slice(2,4),16), b: parseInt(s.slice(4,6),16) }; };
            const cDia = hexToRgb(css('--turno-dia')); const cNoche = hexToRgb(css('--turno-noche')); const cExtraDia = hexToRgb(css('--turno-extra-dia')); const cExtraNoche = hexToRgb(css('--turno-extra-noche'));
            const daysNames = ['Lu','Ma','Mi','Ju','Vi','Sa','Do'];
            if (fmt==='semanal') {
                const total = new Date(year, month+1, 0).getDate();
                const weeks = {};
                for(let d=1; d<=total; d++){ const dt=new Date(year, month, d); const wk=(function(){ const t=new Date(dt.getTime()); t.setHours(0,0,0,0); t.setDate(t.getDate()+3-((t.getDay()+6)%7)); const wk1=new Date(t.getFullYear(),0,4); return 1+Math.round(((t-wk1)/86400000-3+((wk1.getDay()+6)%7))/7); })(); if(!weeks[wk]) weeks[wk]=[]; weeks[wk].push({ d, dow:(dt.getDay()+6)%7, date:dt }); }
                const wkNums = Object.keys(weeks).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
                const margin=20; const leftLabel=120; const colW=120; const headerH=28; const rowH=Math.max(18, Math.min(24, 24)); const weekH = headerH + (allUsers.length)*rowH + 24;
                const width = margin*2 + leftLabel + 7*colW;
                const height = margin + 32 + wkNums.length * weekH + 20;
                canvas.width = width*dpr; canvas.height = height*dpr; canvas.style.width = width+'px'; canvas.style.height = 'auto';
                const ctx = canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
                ctx.fillStyle = '#000000'; ctx.fillRect(0,0,width,height);
                ctx.font = 'bold 18px Helvetica'; ctx.fillStyle = '#ffffff'; const tituloMes = new Date(year, month, 1).toLocaleDateString('es-CL', { month: 'long' }).toUpperCase(); ctx.textAlign='center'; ctx.fillText(`Calendario Unificado · ${tituloMes} ${year}`, width/2, margin);
                ctx.textAlign='left'; let y = margin + 32;
                wkNums.forEach(wkNum=>{
                    ctx.font='bold 14px Helvetica'; ctx.fillStyle='#ffffff'; ctx.fillText(`Semana ${wkNum}`, margin, y+14);
                    ctx.font='12px Helvetica'; ctx.fillStyle='#cccccc'; daysNames.forEach((n,i)=>{ const cx = margin+leftLabel+i*colW+colW/2; ctx.textAlign='center'; ctx.fillText(n, cx, y+headerH-8); }); ctx.textAlign='left';
                    for(let i=0;i<7;i++){ const x=margin+leftLabel+i*colW; const y0=y+headerH; ctx.strokeStyle='#3a3a3a'; ctx.strokeRect(x,y0,colW,(allUsers.length)*rowH+20); }
                    ctx.font='12px Helvetica'; allUsers.forEach((u,ri)=>{ const ry=y+headerH + ri*rowH + rowH/2 + 4; const parts=(u.nombre||'').trim().split(/\s+/); const nm=(parts[0]||'') + (parts.length>1 ? ' ' + (parts[parts.length-1]||'').charAt(0).toUpperCase()+'.' : ''); ctx.fillStyle='#e0e0e0'; ctx.fillText(nm, margin+4, ry); for(let i=0;i<7;i++){ const x=margin+leftLabel+i*colW; const cy=y+headerH + ri*rowH + rowH/2; const dt=weeks[wkNum].find(xx=>xx.dow===i); if(!dt) continue; const data=JSON.parse(localStorage.getItem(`turnos_user_${u.id}`)||'{}'); const tlist=(data[year]?.[month]?.[dt.d]?.turnos)||[]; let cx=x+6; const sq=10; tlist.slice(0,6).forEach(t=>{ let col; let abbr; if(t.includes('extra-noche')){ col=cExtraNoche; abbr='NE'; } else if(t.includes('extra-dia')){ col=cExtraDia; abbr='DE'; } else if(t.includes('noche')){ col=cNoche; abbr='N'; } else { col=cDia; abbr='D'; } ctx.fillStyle=`rgb(${col.r},${col.g},${col.b})`; ctx.fillRect(cx, cy-sq/2, sq, sq); ctx.fillStyle='#000'; ctx.strokeStyle='#000'; ctx.globalAlpha=0.12; ctx.strokeRect(cx, cy-sq/2, sq, sq); ctx.globalAlpha=1; ctx.fillStyle='#ffffff'; ctx.font='10px Helvetica'; ctx.textAlign='center'; ctx.fillText(abbr, cx+sq/2, cy+3); ctx.textAlign='left'; ctx.fillStyle='#ffffff'; cx += sq + 4; }); } });
                    ctx.font='11px Helvetica'; ctx.fillStyle='#999999'; weeks[wkNum].forEach(obj=>{ const x=margin+leftLabel+obj.dow*colW; ctx.fillText(String(obj.d), x+4, y+headerH-10); const fer = esFeriado(obj.date); if (fer) { ctx.fillStyle='#ffdddd'; ctx.fillRect(x, y+headerH, colW, 18); ctx.fillStyle='#c00'; ctx.font='10px Helvetica'; ctx.textAlign='right'; ctx.fillText(fer, x+colW-4, y+headerH-10); ctx.textAlign='left'; } ctx.fillStyle='#999999'; });
                    y += weekH;
                    ctx.strokeStyle='rgba(140,140,140,0.6)'; ctx.setLineDash([4,3]); ctx.beginPath(); ctx.moveTo(margin, y); ctx.lineTo(width-margin, y); ctx.stroke(); ctx.setLineDash([]);
                });
            } else {
                const dpr2 = dpr; const margin = 20; const gridX = margin; const gridW = 1200; const colW = gridW/7; const headerH = 30; const cellH = 110; const totalDays = new Date(year,month+1,0).getDate(); const first = (new Date(year,month,1).getDay()+6)%7; const rows = 6; const width = gridW + margin*2; const height = margin + 32 + headerH + rows*cellH + 20; canvas.width = width*dpr2; canvas.height = height*dpr2; canvas.style.width = width+'px'; const ctx = canvas.getContext('2d'); ctx.setTransform(dpr2,0,0,dpr2,0,0); ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high'; ctx.fillStyle = '#000'; ctx.fillRect(0,0,width,height); ctx.font = 'bold 18px Helvetica'; ctx.fillStyle = '#fff'; const tituloMes = new Date(year,month,1).toLocaleDateString('es-CL',{month:'long'}).toUpperCase(); ctx.textAlign='center'; ctx.fillText(`Calendario Unificado · ${tituloMes} ${year}`, width/2, margin); ctx.textAlign='left'; ctx.font='12px Helvetica'; let lx=gridX; let ly=margin+32; const lineH=18; allUsers.forEach(u=>{ const ps=(u.nombre||'').trim().split(/\s+/); const nm=(ps[0]||'') + (ps.length>1 ? ' ' + (ps[ps.length-1]||'').charAt(0).toUpperCase()+'.' : ''); const col=hexToRgb(u.color||'#FFD180'); ctx.fillStyle=`rgb(${col.r},${col.g},${col.b})`; ctx.fillRect(lx, ly-10, 10, 10); ctx.fillStyle='#e0e0e0'; ctx.fillText(nm, lx+14, ly); lx += 14 + Math.max(40, ctx.measureText(nm).width + 10); if (lx > gridX + gridW - 120) { lx = gridX; ly += lineH; } }); const days=['Lu','Ma','Mi','Ju','Vi','Sa','Do']; for(let i=0;i<7;i++){ const cx=gridX+i*colW+colW/2; ctx.fillStyle='#ccc'; ctx.textAlign='center'; ctx.fillText(days[i], cx, ly+20); } ctx.textAlign='left'; let y0=ly+20+headerH; for(let r=0;r<rows;r++){ for(let c=0;c<7;c++){ const x=gridX+c*colW; ctx.strokeStyle='#3a3a3a'; ctx.strokeRect(x,y0+r*cellH,colW,cellH); const idx=r*7+c-first; if(idx>=0 && idx<totalDays){ const day=idx+1; const date=new Date(year,month,day); const fer=esFeriado(date); if(fer){ ctx.font='10px Helvetica'; const tw=ctx.measureText(fer).width; const padX=6; const tagW=Math.min(colW-12, tw+padX*2); const tagX=x+colW-tagW-6; const tagY=y0+r*cellH+2; ctx.fillStyle='rgba(255,221,221,0.85)'; ctx.fillRect(tagX, tagY, tagW, 14); ctx.fillStyle='#c00'; ctx.textAlign='center'; ctx.fillText(fer, tagX+tagW/2, tagY+10); ctx.textAlign='left'; } ctx.fillStyle='#aaa'; ctx.font='11px Helvetica'; ctx.fillText(String(day), x+4, y0+r*cellH+12); let chips=[]; allUsers.forEach(u=>{ const data=JSON.parse(localStorage.getItem(`turnos_user_${u.id}`)||'{}'); const tlist=(data[year]?.[month]?.[day]?.turnos)||[]; tlist.forEach(t=>{ let col; let abbr; if(t.includes('extra-noche')){ col=cExtraNoche; abbr='NE'; } else if(t.includes('extra-dia')){ col=cExtraDia; abbr='DE'; } else if(t.includes('noche')){ col=cNoche; abbr='N'; } else { col=cDia; abbr='D'; } const ps=(u.nombre||'').trim().split(/\s+/); const nom=(ps[0]||'') + (ps.length>1 ? ' ' + (ps[ps.length-1]||'').charAt(0).toUpperCase()+'.' : ''); chips.push({ abbr, col, nom, uid: u.id }); }); }); chips.forEach(ch=>{ const d=JSON.parse(localStorage.getItem(`turnos_user_${ch.uid}`)||'{}'); const prev=(d[year]?.[month]?.[day-1]?.turnos)||[]; const prevNight=prev.some(v=>v.includes('noche')); ch.rank=(ch.abbr==='D'||ch.abbr==='DE')?3:(prevNight?2:1); }); chips.sort((a,b)=> b.rank - a.rank || a.nom.localeCompare(b.nom)); const cols=1; const sq=8; const gap=6; const cw=(colW-8); const startX=x+4; const startY=y0+r*cellH+24; const lineH2=Math.max(20, sq+gap+6); const maxRows=Math.floor((cellH-24)/lineH2); let overflow=0; ctx.font='10px Helvetica'; ctx.textAlign='left'; ctx.textBaseline='top'; const lumin=(r,g,b)=>0.2126*r+0.7152*g+0.0722*b; chips.forEach((ch, idx)=>{ const colIdx=0; const rowIdx=idx; if(rowIdx>=maxRows){ overflow++; return; } const bx=startX; const by=startY+rowIdx*lineH2; ctx.fillStyle=`rgb(${ch.col.r},${ch.col.g},${ch.col.b})`; ctx.fillRect(bx, by, sq, sq); const tc=lumin(ch.col.r,ch.col.g,ch.col.b)>140?'#000':'#fff'; ctx.fillStyle=tc; ctx.textAlign='center'; ctx.fillText(ch.abbr, bx+sq/2, by+2); ctx.textAlign='left'; ctx.fillStyle='#e0e0e0'; ctx.font='10px Helvetica'; ctx.fillText(ch.nom, bx+sq+6, by+1); }); if (overflow>0) { ctx.fillStyle='#bbb'; ctx.font='10px Helvetica'; ctx.fillText(`+${overflow} más`, x+2, y0 + (r+1)*cellH - 6); } } } }
            }
        }
        function descargarUnificadoJPG() {
            const canvas = document.getElementById('unificadoCanvas'); if (!canvas) return;
            const link = document.createElement('a'); link.href = canvas.toDataURL('image/jpeg', 1.0); link.download = 'calendario_unificado.jpg'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function dibujarMesUnificadoEnPDF(doc, año, mes, usuarios, resumen, colores) {
            doc.setFont('helvetica','bold'); doc.setFontSize(12);
            const nombreMes = new Date(año, mes, 1).toLocaleDateString('es-CL', { month: 'long' }).toUpperCase();
            doc.text(`${nombreMes} ${año}`, 105, 16, { align: 'center' });
            const pageW = doc.internal.pageSize.getWidth(); const margin=10; const gridX=margin; const gridY=18; const gridW=pageW-margin*2; const colW=gridW/7; const headerH=8; const cellH=32;
            doc.setFont('helvetica','normal'); doc.setFontSize(9);
            ['Lu','Ma','Mi','Ju','Vi','Sa','Do'].forEach((d,i)=>{ const cx=gridX+i*colW+colW/2; doc.text(d,cx,gridY+6,{align:'center'}); });
            const first=(new Date(año,mes,1).getDay()+6)%7; const total=new Date(año,mes+1,0).getDate(); doc.setDrawColor(58,58,58);
            const today = new Date(); const isSameMonth = (año===today.getFullYear() && mes===today.getMonth());
            function isoWeek(d){ const dt=new Date(d.getTime()); dt.setHours(0,0,0,0); dt.setDate(dt.getDate()+3-((dt.getDay()+6)%7)); const wk1=new Date(dt.getFullYear(),0,4); return 1+Math.round(((dt-wk1)/86400000-3+((wk1.getDay()+6)%7))/7); }
            function shortName(n){ const t=(n||'').trim().split(/\s+/); return t[0]||n; }
            function abbrFor(lb){ if(lb==='Día') return 'D'; if(lb==='Noche') return 'N'; if(lb==='Día Extra') return 'DE'; if(lb==='Noche Extra') return 'NE'; return lb; }
            const prio = lb => lb==='Noche Extra'||lb==='Día Extra'?2:(lb==='Noche'?1:0);
            for(let r=0;r<6;r++){
                for(let c=0;c<7;c++){
                    const x=gridX+c*colW; const y0=gridY+headerH+r*cellH; const idx=r*7+c-first; const isDay = (idx>=0 && idx<total);
                    if(isDay){ const day=idx+1; const fName = esFeriado(new Date(año, mes, day)); if (fName) { doc.setFillColor(235,235,235); doc.rect(x,y0,colW,cellH,'F'); } }
                    doc.rect(x,y0,colW,cellH);
                    if(isDay){
                        const day=idx+1;
                        doc.text(String(day), x+2, y0+6);
                        const fer = esFeriado(new Date(año, mes, day)); if (fer) { doc.setFontSize(7); doc.text(fer, x+colW-2, y0+6, { align:'right' }); doc.setDrawColor(200,0,0); doc.setLineWidth(0.3); doc.line(x+colW-8, y0+4, x+colW-8, y0+9); doc.setFillColor(200,0,0); doc.rect(x+colW-8, y0+4, 6, 3, 'F'); doc.setFontSize(9); }
                        if (isSameMonth && day===today.getDate()) { doc.setDrawColor(66,165,245); doc.setLineWidth(0.8); doc.rect(x,y0,colW,cellH); doc.setLineWidth(0.2); doc.setDrawColor(58,58,58); }
                        let chips=[];
                        usuarios.forEach(u=>{
                            const raw=localStorage.getItem(`turnos_user_${u.id}`); const data= raw? JSON.parse(raw):{};
                            const tlist=(data[año]?.[mes]?.[day]?.turnos)||[];
                            tlist.forEach(t=>{
                                let lb; let col;
                                if(t.includes('extra-noche')){ lb='Noche Extra'; col=colores.cExtraNoche; resumen.find(rr=>rr.id===u.id).extraNoche++; }
                                else if(t.includes('extra-dia')){ lb='Día Extra'; col=colores.cExtraDia; resumen.find(rr=>rr.id===u.id).extraDia++; }
                                else if(t.includes('noche')){ lb='Noche'; col=colores.cNoche; resumen.find(rr=>rr.id===u.id).noche++; }
                                else { lb='Día'; col=colores.cDia; resumen.find(rr=>rr.id===u.id).dia++; }
                                const parts=(u.nombre||'').trim().split(/\s+/); const ini=((parts[0]||'').charAt(0)||'')+(((parts.length>1?parts[parts.length-1]:parts[0]||'').charAt(0))||'');
                                chips.push({ ini, abbr: abbrFor(lb), col, pr: prio(lb) });
                            });
                        });
                        chips.sort((a,b)=> b.pr - a.pr || a.ini.localeCompare(b.ini));
                        const cols = 4; const sq = 5; const gap = 1; const cw = (colW - 4) / cols; const startX = x + 2; const startY = y0 + 12; const lineH = sq + gap + 1; const maxRows = Math.floor((cellH - 14) / lineH);
                        let overflow = 0; doc.setFontSize(5);
                        const lumin = (r,g,b)=> 0.2126*r + 0.7152*g + 0.0722*b;
                        chips.forEach((ch, idx) => {
                            const colIdx = idx % cols; const rowIdx = Math.floor(idx / cols);
                            if (rowIdx >= maxRows) { overflow++; return; }
                            const bx = startX + colIdx * cw; const by = startY + rowIdx * lineH;
                            const text = `${ch.abbr}`;
                            doc.setFillColor(ch.col.r, ch.col.g, ch.col.b);
                            doc.rect(bx, by - sq + 1, sq, sq, 'F');
                            const tc = lumin(ch.col.r, ch.col.g, ch.col.b) > 140 ? {r:0,g:0,b:0} : {r:255,g:255,b:255};
                            doc.setTextColor(tc.r, tc.g, tc.b);
                            doc.text(text, bx + sq/2, by - sq/2 + 1.5, { align: 'center' });
                            doc.setTextColor(0,0,0);
                        });
                        if (overflow>0) { doc.setFontSize(7); doc.text(`+${overflow} más`, x+2, y0 + cellH - 2); doc.setFontSize(9); }
                    }
                }
                // línea divisoria de semana (punteada) y número de semana
                const yLine = gridY+headerH+(r+1)*cellH; 
                const dash = 3, gap = 2; let xDash = gridX; doc.setLineWidth(0.6); doc.setDrawColor(140,140,140);
                while (xDash < gridX+gridW) { const nx = Math.min(xDash + dash, gridX + gridW); doc.line(xDash, yLine, nx, yLine); xDash = nx + gap; }
                doc.setLineWidth(0.2); doc.setDrawColor(58,58,58);
                const idxMon = r*7 - first; const dayMon = (idxMon<0)?1:((idxMon>=total)?total:idxMon+1); 
                const wNum = isoWeek(new Date(año, mes, dayMon)); 
                doc.setFontSize(7); doc.text(`Semana ${wNum}`, gridX-2, yLine - cellH/2, { align:'right' }); doc.setFontSize(9);
            }
        }

        // Filtrar turnos
        function filtrarTurnos(tipo) {
            const dias = document.querySelectorAll('.day:not(.day-header):not(.empty-day)');
            dias.forEach(dia => {
                const turnosDia = dia.querySelectorAll('.turno, .mobile-turno-indicator');
                let mostrar = false;

                if (tipo === 'todos') {
                    mostrar = true;
                } else if (tipo === 'normales') {
                    mostrar = Array.from(turnosDia).some(turno => 
                        !turno.className.includes('extra') && 
                        !turno.className.includes('mobile-extra')
                    );
                } else if (tipo === 'extras') {
                    mostrar = Array.from(turnosDia).some(turno => 
                        turno.className.includes('extra') || 
                        turno.className.includes('mobile-extra')
                    );
                }

                dia.style.display = mostrar ? '' : 'none';
            });
        }

        // Buscar por fecha
        function buscarPorFecha() {
            const fechaInput = document.getElementById('buscarFecha').value;
            if (!fechaInput) {
                mostrarAlerta('Ingresa una fecha válida');
                return;
            }

            const fecha = new Date(fechaInput);
            if (isNaN(fecha.getTime())) {
                mostrarAlerta('Fecha no válida');
                return;
            }

            const dia = fecha.getDate();
            const mes = fecha.getMonth();
            const año = fecha.getFullYear();
            
            // Cambiar el calendario al mes de la fecha buscada
            if (año.toString() !== document.getElementById('yearSelect').value || 
                mes.toString() !== document.getElementById('monthSelect').value) {
                document.getElementById('yearSelect').value = año;
                document.getElementById('monthSelect').value = mes;
                actualizarCalendario();
            }
            
            // Resaltar el día
            const diaElemento = document.querySelector(`.day[data-dia="${dia}"][data-mes="${mes}"][data-anio="${año}"]`);
            if (diaElemento) {
                // Quitar resaltado anterior
                document.querySelectorAll('.day-highlight').forEach(el => {
                    el.classList.remove('day-highlight');
                });
                
                // Agregar clase de resaltado
                diaElemento.classList.add('day-highlight');
                diaElemento.style.border = '2px solid var(--secondary)';
                
                // Desplazar a la vista
                diaElemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Quitar resaltado después de 3 segundos
                setTimeout(() => {
                    diaElemento.classList.remove('day-highlight');
                    diaElemento.style.border = '1px solid rgba(0, 0, 0, 0.1)';
                }, 3000);
            } else {
                mostrarAlerta('Fecha no encontrada');
            }
        }

        // Importar datos desde TXT
        function importarDesdeTXT(event) {
            const archivo = event.target.files[0];
            if (!archivo) return;
            
            const lector = new FileReader();
            
            lector.onload = function(e) {
                try {
                    const contenido = e.target.result;
                    const lineas = contenido.split('\n');
                    
                    // Crear un nuevo objeto para almacenar los turnos importados
                    const nuevosTurnos = JSON.parse(JSON.stringify(turnos)) || {};
                    
                    lineas.forEach(linea => {
                        // Aceptar varios formatos de fecha (dd-mm-yyyy o dd/mm/yyyy)
                        const match = linea.match(/\((\d{2}[\/\-]\d{2}[\/\-]\d{4})\)\s*-\s*(Día|Noche|DÍA|NOCHE)/i);
                        if (match) {
                            let [_, fechaStr, turnoTipo] = match;
                            // Normalizar el separador a guión
                            fechaStr = fechaStr.replace(/\//g, '-');
                            const [dia, mes, año] = fechaStr.split('-').map(Number);

                            // Ajustar el mes (los meses en JavaScript van de 0 a 11)
                            const mesAjustado = mes - 1;

                            // Determinar si es extra
                            const esExtra = linea.toLowerCase().includes('extra');

                            // Definir el tipo de turno adecuadamente
                            const turnoFormateado = (turnoTipo.toLowerCase().includes('día') || 
                                                    turnoTipo.toLowerCase().includes('dia')) ? 'dia' : 'noche';
                            
                            // Crear el turno con el formato correcto
                            const turnoFinal = esExtra ? `extra-${turnoFormateado}` : turnoFormateado;
                            
                            // Asegurarse de que existan las estructuras necesarias
                            if (!nuevosTurnos[año]) nuevosTurnos[año] = {};
                            if (!nuevosTurnos[año][mesAjustado]) nuevosTurnos[año][mesAjustado] = {};
                            if (!nuevosTurnos[año][mesAjustado][dia]) {
                                nuevosTurnos[año][mesAjustado][dia] = { turnos: [], nota: '' };
                            }
                            
                            // Agregar el turno si no existe ya
                            if (!nuevosTurnos[año][mesAjustado][dia].turnos.includes(turnoFinal)) {
                                nuevosTurnos[año][mesAjustado][dia].turnos.push(turnoFinal);
                            }
                        }
                    });
                    
                    // Actualizar el objeto turnos y guardar los datos
                    turnos = nuevosTurnos;
                    guardarDatos();
                    actualizarCalendario();
                    mostrarAlerta('Datos importados correctamente');
                } catch (error) {
                    console.error('Error al importar:', error);
                    mostrarAlerta('Error al importar el archivo');
                }
            };
            
            lector.onerror = function() {
                mostrarAlerta('Error al leer el archivo');
            };
            
            lector.readAsText(archivo);
            
            // Limpiar el input para permitir importar el mismo archivo de nuevo
            event.target.value = '';
        }

        // Inicializar tema según preferencias del sistema
        function inicializarTema() {
            document.body.classList.add('dark-mode');
            localStorage.setItem('tema', 'oscuro');
            const icono = document.querySelector('[onclick="cambiarTema()"] i');
            if (icono) {
                icono.classList.remove('fa-moon');
                icono.classList.add('fa-sun');
            }
        }

        // Función para mostrar/ocultar opciones personalizadas
        function toggleCustomPattern() {
            const patronSelect = document.getElementById('patronSelect');
            const customPatternDiv = document.getElementById('customPatternDiv');
            
            if (patronSelect.value === 'custom') {
                customPatternDiv.classList.remove('hidden');
            } else {
                customPatternDiv.classList.add('hidden');
            }
        }

        // Función para completar automáticamente el calendario con el patrón específico
        function completarCalendario() {
            const año = parseInt(document.getElementById('yearSelect').value);
            const mes = parseInt(document.getElementById('monthSelect').value);
            const patronSelect = document.getElementById('patronSelect').value;
            const tipoRotacion = document.getElementById('tipoRotacion').value;
            
            // Determinar días de trabajo y descanso según el patrón
            let diasTrabajo, diasDescanso;
            
            if (patronSelect === 'custom') {
                diasTrabajo = parseInt(document.getElementById('diasTrabajo').value);
                diasDescanso = parseInt(document.getElementById('diasDescanso').value);
            } else {
                [diasTrabajo, diasDescanso] = patronSelect.split('x').map(Number);
            }
            
            if (!diasTrabajo || !diasDescanso || diasTrabajo < 1 || diasDescanso < 1) {
                mostrarAlerta('Por favor ingresa un patrón válido');
                return;
            }
            
            // Confirmar antes de sobrescribir
            if (!confirm(`¿Estás seguro de completar el mes con un patrón de ${diasTrabajo}x${diasDescanso}?`)) {
                return;
            }
            
            // Limpiar el mes actual
            if (turnos[año]?.[mes]) {
                delete turnos[año][mes];
            }
            
            if (!turnos[año]) turnos[año] = {};
            if (!turnos[año][mes]) turnos[año][mes] = {};
            
            // Determinar fecha de inicio
            let fechaInicio;
            const fechaInicioInput = document.getElementById('fechaInicio').value;
            
            if (fechaInicioInput) {
                // Usar la fecha seleccionada por el usuario
                const [añoInicio, mesInicio, diaInicio] = fechaInicioInput.split('-').map(Number);
                fechaInicio = new Date(añoInicio, mesInicio - 1, diaInicio);
            } else {
                // Usar el primer día del mes
                fechaInicio = new Date(año, mes, 1);
            }
            
            // Calcular el día del ciclo en que comienza el mes
            const diasEnMes = new Date(año, mes + 1, 0).getDate();
            const cicloDias = diasTrabajo + diasDescanso;
            
            // Para el patrón noche-noche-día, necesitamos un ciclo completo de 18 días
            // (3 noches + 3 descanso + 3 noches + 3 descanso + 3 días + 3 descanso)
            const partesRotacion = tipoRotacion.split('-');
            const cicloCompleto = (partesRotacion.length === 3) ? cicloDias * 3 : cicloDias;
            
            // Calcular días transcurridos desde la fecha de inicio hasta el primer día del mes
            const diffTime = new Date(año, mes, 1) - fechaInicio;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Determinar en qué día del ciclo completo estamos al iniciar el mes
            let diaEnCicloCompleto = (diffDays % cicloCompleto + cicloCompleto) % cicloCompleto;
            
            // Completar el calendario
            for (let dia = 1; dia <= diasEnMes; dia++) {
                // Determinar si es día de trabajo o descanso
                const esDiaTrabajo = diaEnCicloCompleto % cicloDias < diasTrabajo;
                
                if (esDiaTrabajo) {
                    let tipoTurnoActual;
                    
                    if (partesRotacion.length === 3) {
                        const subCiclo = Math.floor(diaEnCicloCompleto / cicloDias);
                        tipoTurnoActual = partesRotacion[subCiclo];
                    } else if (tipoRotacion === 'dia-noche') {
                        tipoTurnoActual = Math.floor(diaEnCicloCompleto / cicloDias) % 2 === 0 ? 'dia' : 'noche';
                    } else if (tipoRotacion === 'solo-dia') {
                        tipoTurnoActual = 'dia';
                    } else {
                        tipoTurnoActual = 'noche';
                    }
                    
                    // Agregar el turno
                    if (!turnos[año][mes][dia]) {
                        turnos[año][mes][dia] = { turnos: [], nota: '' };
                    }
                    
                    turnos[año][mes][dia].turnos.push(tipoTurnoActual);
                }
                
                // Avanzar en el ciclo
                diaEnCicloCompleto = (diaEnCicloCompleto + 1) % cicloCompleto;
            }
            
            // Guardar y actualizar
            guardarDatos();
            localStorage.setItem('configAutollenado', JSON.stringify({
                diasTrabajo,
                diasDescanso,
                tipoRotacion,
                fechaInicio: fechaInicioInput || null
            }));
            actualizarCalendario();
            mostrarAlerta('Calendario completado automáticamente');
        }

        function completarCalendarioParaMes(config, año, mes) {
            const diasTrabajo = parseInt(config.diasTrabajo);
            const diasDescanso = parseInt(config.diasDescanso);
            const tipoRotacion = config.tipoRotacion;
            let fechaInicio;
            if (config.fechaInicio) {
                const [añoInicio, mesInicio, diaInicio] = config.fechaInicio.split('-').map(Number);
                fechaInicio = new Date(añoInicio, mesInicio - 1, diaInicio);
            } else {
                fechaInicio = new Date(año, mes, 1);
            }
            if (!turnos[año]) turnos[año] = {};
            if (turnos[año][mes]) delete turnos[año][mes];
            turnos[año][mes] = {};
            const diasEnMes = new Date(año, mes + 1, 0).getDate();
            const cicloDias = diasTrabajo + diasDescanso;
            const partesRotacion = tipoRotacion.split('-');
            const cicloCompleto = (partesRotacion.length === 3) ? cicloDias * 3 : cicloDias;
            const diffTime = new Date(año, mes, 1) - fechaInicio;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            let diaEnCicloCompleto = (diffDays % cicloCompleto + cicloCompleto) % cicloCompleto;
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const esDiaTrabajo = diaEnCicloCompleto % cicloDias < diasTrabajo;
                if (esDiaTrabajo) {
                    let tipoTurnoActual;
                    if (partesRotacion.length === 3) {
                        const subCiclo = Math.floor(diaEnCicloCompleto / cicloDias);
                        tipoTurnoActual = partesRotacion[subCiclo];
                    } else if (tipoRotacion === 'dia-noche') {
                        tipoTurnoActual = Math.floor(diaEnCicloCompleto / cicloDias) % 2 === 0 ? 'dia' : 'noche';
                    } else if (tipoRotacion === 'solo-dia') {
                        tipoTurnoActual = 'dia';
                    } else {
                        tipoTurnoActual = 'noche';
                    }
                    turnos[año][mes][dia] = { turnos: [tipoTurnoActual], nota: '' };
                }
                diaEnCicloCompleto = (diaEnCicloCompleto + 1) % cicloCompleto;
            }
        }

        function validarMesConConfig(año, mes, config) {
            const diasTrabajo = parseInt(config.diasTrabajo);
            const diasDescanso = parseInt(config.diasDescanso);
            const tipoRotacion = config.tipoRotacion;
            let fechaInicio;
            if (config.fechaInicio) {
                const [añoInicio, mesInicio, diaInicio] = config.fechaInicio.split('-').map(Number);
                fechaInicio = new Date(añoInicio, mesInicio - 1, diaInicio);
            } else {
                fechaInicio = new Date(año, mes, 1);
            }
            const diasEnMes = new Date(año, mes + 1, 0).getDate();
            const cicloDias = diasTrabajo + diasDescanso;
            const partesRotacion = tipoRotacion.split('-');
            const cicloCompleto = (partesRotacion.length === 3) ? cicloDias * 3 : cicloDias;
            const diffTime = new Date(año, mes, 1) - fechaInicio;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            let diaEnCicloCompleto = (diffDays % cicloCompleto + cicloCompleto) % cicloCompleto;
            let errores = 0;
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const esDiaTrabajo = diaEnCicloCompleto % cicloDias < diasTrabajo;
                const datosDia = turnos[año]?.[mes]?.[dia];
                let esperadoTurno = null;
                if (esDiaTrabajo) {
                    if (partesRotacion.length === 3) {
                        const subCiclo = Math.floor(diaEnCicloCompleto / cicloDias);
                        esperadoTurno = partesRotacion[subCiclo];
                    } else if (tipoRotacion === 'dia-noche') {
                        esperadoTurno = Math.floor(diaEnCicloCompleto / cicloDias) % 2 === 0 ? 'dia' : 'noche';
                    } else if (tipoRotacion === 'solo-dia') {
                        esperadoTurno = 'dia';
                    } else {
                        esperadoTurno = 'noche';
                    }
                    if (!datosDia || !datosDia.turnos || !datosDia.turnos.includes(esperadoTurno)) {
                        errores++;
                    }
                } else {
                    if (datosDia) {
                        errores++;
                    }
                }
                diaEnCicloCompleto = (diaEnCicloCompleto + 1) % cicloCompleto;
            }
            return { valido: errores === 0, errores };
        }

        function autollenarSiguientesMeses() {
            const añoActual = parseInt(document.getElementById('yearSelect').value);
            const mesActual = parseInt(document.getElementById('monthSelect').value);
            const meses = Math.max(1, Math.min(24, parseInt(document.getElementById('mesesAuto').value)));
            const sobrescribir = document.getElementById('sobrescribirAuto').checked;
            const deduccion = deducirConfiguracionDesdeMes(añoActual, mesActual);
            if (!deduccion) { mostrarAlerta('No hay patrón detectable en el mes actual'); return; }
            let completados = 0;
            let saltados = 0;
            let estado = deduccion.estadoSiguiente;
            for (let offset = 1; offset <= meses; offset++) {
                const mesDestino = (mesActual + offset) % 12;
                const añoDestino = añoActual + Math.floor((mesActual + offset) / 12);
                const yaTiene = turnos[añoDestino]?.[mesDestino];
                if (!sobrescribir && yaTiene) { saltados++; continue; }
                estado = completarMesContinuo(deduccion.config, estado, añoDestino, mesDestino, true);
                completados++;
            }
            guardarDatos();
            actualizarCalendario();
            mostrarAlerta(`Autocompletado siguiendo el patrón actual: ${completados} meses, saltados: ${saltados}`);
        }

        function autollenarMesSiguiente() {
            const añoActual = parseInt(document.getElementById('yearSelect').value);
            const mesActual = parseInt(document.getElementById('monthSelect').value);
            const sobrescribir = document.getElementById('sobrescribirAuto').checked;
            const deduccion = deducirConfiguracionDesdeMes(añoActual, mesActual);
            if (!deduccion) {
                mostrarAlerta('No hay patrón detectable en el mes actual');
                return;
            }
            const mesDestino = (mesActual + 1) % 12;
            const añoDestino = añoActual + Math.floor((mesActual + 1) / 12);
            completarMesContinuo(deduccion.config, deduccion.estadoSiguiente, añoDestino, mesDestino, sobrescribir);
            guardarDatos();
            document.getElementById('yearSelect').value = añoDestino;
            document.getElementById('monthSelect').value = mesDestino;
            actualizarCalendario();
            mostrarAlerta('Mes siguiente autocompletado siguiendo el patrón actual');
        }

        function autollenarAnual() {
            const añoActual = parseInt(document.getElementById('yearSelect').value);
            const mesActual = parseInt(document.getElementById('monthSelect').value);
            const sobrescribir = document.getElementById('sobrescribirAuto').checked;
            const deduccion = deducirConfiguracionDesdeMes(añoActual, mesActual);
            if (!deduccion) {
                mostrarAlerta('No hay patrón detectable en el mes actual');
                return;
            }
            let completados = 0;
            let saltados = 0;
            let estado = deduccion.estadoSiguiente;
            const inicio = mesActual + 1;
            let añoDestino = añoActual;
            let iStart = inicio;
            if (iStart > 11) {
                añoDestino = añoActual + 1;
                iStart = 0;
            }
            for (let i = iStart; i < 12; i++) {
                const mesDestino = i;
                const yaTiene = turnos[añoDestino]?.[mesDestino];
                if (!sobrescribir && yaTiene) { saltados++; continue; }
                estado = completarMesContinuo(deduccion.config, estado, añoDestino, mesDestino, true);
                completados++;
            }
            guardarDatos();
            actualizarCalendario();
            mostrarAlerta(`Autocompletado anual siguiendo el patrón: ${completados}, saltados: ${saltados}`);
        }

        function deducirConfiguracionDesdeMes(año, mes) {
            const diasEnMes = new Date(año, mes + 1, 0).getDate();
            const dias = [];
            for (let d = 1; d <= diasEnMes; d++) {
                const datos = turnos[año]?.[mes]?.[d];
                if (datos && datos.turnos && datos.turnos.length > 0) {
                    const t = datos.turnos[0];
                    const base = t.includes('dia') ? 'dia' : 'noche';
                    dias.push({ tipo: 'trabajo', turno: base });
                } else {
                    dias.push({ tipo: 'descanso' });
                }
            }
            // Construir runs
            const runs = [];
            let current = null;
            dias.forEach(day => {
                if (!current || current.tipo !== day.tipo || (day.tipo === 'trabajo' && current.turno !== day.turno)) {
                    if (current) runs.push(current);
                    current = { tipo: day.tipo, len: 1, turno: day.turno || null };
                } else {
                    current.len++;
                }
            });
            if (current) runs.push(current);
            const trabajoRuns = runs.filter(r => r.tipo === 'trabajo');
            const descansoRuns = runs.filter(r => r.tipo === 'descanso');
            if (trabajoRuns.length === 0) return null;
            const moda = arr => {
                const c = {};
                arr.forEach(v => c[v] = (c[v] || 0) + 1);
                return parseInt(Object.entries(c).sort((a,b)=>b[1]-a[1])[0][0]);
            };
            const diasTrabajo = moda(trabajoRuns.map(r => r.len));
            const diasDescanso = descansoRuns.length ? moda(descansoRuns.map(r => r.len)) : 0;
            const secuencias = trabajoRuns.map(r => r.turno);
            // Detectar periodo 1..3
            let periodo = 1;
            for (let p = 1; p <= 3; p++) {
                let ok = true;
                for (let i = 0; i < secuencias.length; i++) {
                    if (secuencias[i] !== secuencias[i % p]) { ok = false; break; }
                }
                if (ok) { periodo = p; break; }
            }
            const partesRotacion = secuencias.slice(0, periodo);
            // Estado para el siguiente día al finalizar el mes
            const lastRun = runs[runs.length - 1];
            const trabajoCount = trabajoRuns.length;
            let subIdx = (lastRun.tipo === 'trabajo') ? (trabajoCount - 1) % partesRotacion.length : (trabajoCount % partesRotacion.length);
            let estadoSiguiente;
            if (lastRun.tipo === 'trabajo') {
                if (lastRun.len < diasTrabajo) {
                    estadoSiguiente = { esTrabajo: true, workPos: lastRun.len, restPos: 0, subCicloIndex: subIdx };
                } else {
                    estadoSiguiente = { esTrabajo: false, workPos: 0, restPos: 0, subCicloIndex: (subIdx + 1) % partesRotacion.length };
                }
            } else {
                if (lastRun.len < diasDescanso) {
                    estadoSiguiente = { esTrabajo: false, workPos: 0, restPos: lastRun.len, subCicloIndex: subIdx };
                } else {
                    estadoSiguiente = { esTrabajo: true, workPos: 0, restPos: 0, subCicloIndex: subIdx };
                }
            }
            return { config: { diasTrabajo, diasDescanso, partesRotacion }, estadoSiguiente };
        }

        function completarMesContinuo(config, estado, año, mes, sobrescribir) {
            if (!turnos[año]) turnos[año] = {};
            if (!sobrescribir && turnos[año][mes]) return estado;
            turnos[año][mes] = {};
            const diasEnMes = new Date(año, mes + 1, 0).getDate();
            for (let d = 1; d <= diasEnMes; d++) {
                if (estado.esTrabajo) {
                    const tipoTurnoActual = config.partesRotacion[estado.subCicloIndex];
                    turnos[año][mes][d] = { turnos: [tipoTurnoActual], nota: '' };
                    estado.workPos++;
                    if (estado.workPos >= config.diasTrabajo) {
                        estado.esTrabajo = false;
                        estado.workPos = 0;
                        estado.restPos = 0;
                        estado.subCicloIndex = (estado.subCicloIndex + 1) % config.partesRotacion.length;
                    }
                } else {
                    estado.restPos++;
                    if (estado.restPos >= config.diasDescanso) {
                        estado.esTrabajo = true;
                        estado.workPos = 0;
                        estado.restPos = 0;
                    }
                }
            }
            return estado;
        }

        // Función para cambiar entre pestañas
        function cambiarPestaña(pestañaId) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones de pestaña
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones de navegación móvil
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activar la pestaña seleccionada
            const tabContent = document.getElementById('tab-' + pestañaId);
            if (tabContent) {
                tabContent.classList.add('active');
            } else {
                console.error('No se encontró el contenido de la pestaña:', 'tab-' + pestañaId);
            }
            
            // Activar el botón de la pestaña
            const tabButton = document.querySelector(`.tab[onclick="cambiarPestaña('${pestañaId}')"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Activar el botón de navegación móvil
            const mobileButton = document.querySelector(`.mobile-nav-item[onclick="cambiarPestaña('${pestañaId}')"]`);
            if (mobileButton) {
                mobileButton.classList.add('active');
            }
            
            // Actualizar estadísticas si estamos en esa pestaña
            if (pestañaId === 'estadisticas') {
                calcularEstadisticas();
            }
            
            // Comentado para no mostrar mensajes en la consola
            // console.log('Cambiando a pestaña:', pestañaId);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Iniciar con el mes actual
            const fechaActual = new Date();
            document.getElementById('yearSelect').value = fechaActual.getFullYear();
            document.getElementById('monthSelect').value = fechaActual.getMonth();
            actualizarCalendario();
            
            // Evento para importar desde TXT
            const importarArchivo = document.getElementById('importarArchivo');
            if (importarArchivo) {
                importarArchivo.addEventListener('change', importarDesdeTXT);
            }
            
            // Cerrar el modal al hacer clic fuera
            const turnoModal = document.getElementById('turnoModal');
            if (turnoModal) {
                turnoModal.addEventListener('click', (e) => {
                    if (e.target.id === 'turnoModal') {
                        cerrarModal();
                    }
                });
            }
            
            // Inicializar tema
            inicializarTema();
            // Usuarios independientes
            cargarUsuarios();
            renderUsuariosManager();
            renderUsuariosSwitcher();
            const fySel = document.getElementById('rangoInicioAño');
            const tySel = document.getElementById('rangoFinAño');
            if (fySel && tySel) {
                const base = new Date().getFullYear();
                const years = [base-1, base, base+1];
                fySel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
                tySel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
                fySel.value = document.getElementById('yearSelect').value;
                tySel.value = document.getElementById('yearSelect').value;
                const fmSel = document.getElementById('rangoInicioMes');
                const tmSel = document.getElementById('rangoFinMes');
                if (fmSel && tmSel) {
                    fmSel.value = document.getElementById('monthSelect').value;
                    tmSel.value = document.getElementById('monthSelect').value;
                }
            }
            
            // Nuevo event listener para el selector de patrón
            const patronSelect = document.getElementById('patronSelect');
            if (patronSelect) {
                patronSelect.addEventListener('change', toggleCustomPattern);
            }
            
            // Inicializar pestañas
            cambiarPestaña('calendario');
            const calendarAll = document.getElementById('calendar');
            if (calendarAll) {
                let startMouseX = null;
                calendarAll.addEventListener('mousedown', (e) => {
                    startMouseX = e.clientX;
                });
                calendarAll.addEventListener('mouseup', (e) => {
                    if (startMouseX === null) return;
                    const dx = e.clientX - startMouseX;
                    const threshold = 80;
                    if (dx < -threshold) {
                        const año = parseInt(document.getElementById('yearSelect').value);
                        const mes = parseInt(document.getElementById('monthSelect').value);
                        const nuevoMes = (mes + 1) % 12;
                        const nuevoAño = año + Math.floor((mes + 1) / 12);
                        document.getElementById('yearSelect').value = nuevoAño;
                        document.getElementById('monthSelect').value = nuevoMes;
                        actualizarCalendario();
                    } else if (dx > threshold) {
                        const año = parseInt(document.getElementById('yearSelect').value);
                        const mes = parseInt(document.getElementById('monthSelect').value);
                        const nuevoMes = (mes + 11) % 12;
                        const nuevoAño = año - (mes === 0 ? 1 : 0);
                        document.getElementById('yearSelect').value = nuevoAño;
                        document.getElementById('monthSelect').value = nuevoMes;
                        actualizarCalendario();
                    }
                    startMouseX = null;
                });
            }

            // Atajos de teclado para cambiar mes/año fácilmente
            document.addEventListener('keydown', (e) => {
                const tag = (document.activeElement && document.activeElement.tagName) || '';
                const isForm = ['INPUT', 'SELECT', 'TEXTAREA'].includes(tag);
                if (isForm) return;
                if (e.key === 'ArrowLeft') {
                    cambiarMes(-1);
                } else if (e.key === 'ArrowRight') {
                    cambiarMes(1);
                } else if (e.key === 'ArrowUp') {
                    cambiarAño(1);
                } else if (e.key === 'ArrowDown') {
                    cambiarAño(-1);
                }
            });
            
            // Detectar si es dispositivo móvil para ajustar la interfaz
            if (window.innerWidth <= 640) {
                ajustarAlturaCalendario();
                window.addEventListener('resize', ajustarAlturaCalendario);
                const calendar = document.getElementById('calendar');
                if (calendar) {
                    let startX = null;
                    calendar.addEventListener('touchstart', (e) => {
                        startX = e.touches[0].clientX;
                    });
                    calendar.addEventListener('touchend', (e) => {
                        if (startX === null) return;
                        const endX = e.changedTouches[0].clientX;
                        const dx = endX - startX;
                        const threshold = 50;
                        if (dx < -threshold) {
                            const año = parseInt(document.getElementById('yearSelect').value);
                            const mes = parseInt(document.getElementById('monthSelect').value);
                            const nuevoMes = (mes + 1) % 12;
                            const nuevoAño = año + Math.floor((mes + 1) / 12);
                            document.getElementById('yearSelect').value = nuevoAño;
                            document.getElementById('monthSelect').value = nuevoMes;
                            actualizarCalendario();
                        } else if (dx > threshold) {
                            const año = parseInt(document.getElementById('yearSelect').value);
                            const mes = parseInt(document.getElementById('monthSelect').value);
                            const nuevoMes = (mes + 11) % 12;
                            const nuevoAño = año - (mes === 0 ? 1 : 0);
                            document.getElementById('yearSelect').value = nuevoAño;
                            document.getElementById('monthSelect').value = nuevoMes;
                            actualizarCalendario();
                        }
                        startX = null;
                    });
                }
            }

            // Inicializar estado de vista anual visible/oculta
            const annual = document.getElementById('annualView');
            const annualHidden = localStorage.getItem('annualViewHidden') === '1';
            const iconAnnual = document.getElementById('annualToggleIcon');
            const monthly = document.getElementById('monthlyContainer');
            if (annual) {
                annual.classList.remove('hidden');
                annual.classList.toggle('annual-collapsed', annualHidden);
            }
            if (iconAnnual) {
                iconAnnual.classList.remove('fa-eye', 'fa-eye-slash');
                iconAnnual.classList.add(annualHidden ? 'fa-eye-slash' : 'fa-eye');
            }
            if (monthly) {
                monthly.classList.remove('md:col-span-2', 'md:col-span-3');
                monthly.classList.add(annualHidden ? 'md:col-span-3' : 'md:col-span-2');
                monthly.classList.toggle('expanded', annualHidden);
            }

            
        });

        // Función para ajustar la altura del calendario en móviles
        function ajustarAlturaCalendario() {
            const calendar = document.getElementById('calendar');
            if (calendar) {
                const days = calendar.querySelectorAll('.day:not(.day-header):not(.empty-day)');
                const screenWidth = window.innerWidth;
                
                if (screenWidth <= 480) {
                    days.forEach(day => {
                        day.style.minHeight = '35px';
                    });
                } else if (screenWidth <= 640) {
                    days.forEach(day => {
                        day.style.minHeight = '40px';
                    });
                } else {
                    days.forEach(day => {
                        day.style.minHeight = '80px';
                    });
                }
            }
        }
    </script>
    <!-- Actualizar el modal para asegurar visibilidad en modo oscuro -->
    <!-- Modal para agregar/quitar turnos -->
    <div id="turnoModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Gestionar Turno</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Tipo de Turno</label>
                <select id="turnoSelect" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700">
                    <option value="dia">Día</option>
                    <option value="noche">Noche</option>
                    <option value="extra-dia">Extra Día</option>
                    <option value="extra-noche">Extra Noche</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Nota (opcional)</label>
                <textarea id="nota" rows="3" class="w-full p-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700"></textarea>
            </div>
            <div class="mb-4 flex items-center">
                <input type="checkbox" id="bloquearDia" class="mr-2">
                <label for="bloquearDia" class="text-sm">Bloquear día (evita cambios)</label>
            </div>
            <div class="flex justify-between">
                <button onclick="agregarTurno()" class="btn-primary px-4 py-2 rounded">Agregar</button>
                <button onclick="quitarTurno()" class="btn-secondary px-4 py-2 rounded">Quitar</button>
                <button onclick="cerrarModal()" class="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Previsualización de Autocompletar -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Previsualización de Autocompletar</h3>
            <div id="previewContent" class="mb-4 text-sm"></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <button onclick="autollenarMesSiguiente(); cerrarPreview();" class="btn-secondary px-4 py-2 rounded">Aplicar Mes Siguiente</button>
                <button onclick="autollenarSiguientesMeses(); cerrarPreview();" class="btn-primary px-4 py-2 rounded">Aplicar N Meses</button>
                <button onclick="autollenarAnual(); cerrarPreview();" class="btn-primary px-4 py-2 rounded">Aplicar Año</button>
            </div>
            <div class="mt-3 text-right">
                <button onclick="cerrarPreview()" class="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded">Cerrar</button>
            </div>
        </div>
    </div>
    <!-- Menú de navegación inferior para móviles -->
    <div class="mobile-nav fixed bottom-0 left-0 right-0 bg-black shadow-lg z-10 md:hidden">
        <div class="flex justify-around items-center p-2">
            <div class="mobile-nav-item active" onclick="cambiarPestaña('calendario')">
                <i class="fas fa-calendar"></i>
                <span>Calendario</span>
            </div>
            <div class="mobile-nav-item" onclick="cambiarPestaña('estadisticas')">
                <i class="fas fa-chart-bar"></i>
                <span>Estadísticas</span>
            </div>
            <div class="mobile-nav-item" onclick="cambiarPestaña('herramientas')">
                <i class="fas fa-tools"></i>
                <span>Herramientas</span>
            </div>
            <div class="mobile-nav-item" onclick="cambiarPestaña('configuracion')">
                <i class="fas fa-cog"></i>
                <span>Config</span>
            </div>
        </div>
    </div>
</body>
</html>
